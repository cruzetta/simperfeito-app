<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor da Página do Evento - Sim, Perfeito</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Cormorant+Garamond:wght@400;600;700&family=Dancing+Script:wght@700&family=Montserrat:wght@400;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- CSS do Swiper.js para o Carrossel -->
    <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css" />
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F3F4F6; }

        /* Estilos do Editor de Texto Flutuante e Guias de Alinhamento */
        #text-editor-toolbar {
            position: absolute;
            display: none;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 8px;
            z-index: 100;
            gap: 4px;
        }
        #text-editor-toolbar select, #text-editor-toolbar input, #text-editor-toolbar button {
            border: 1px solid #D1D5DB;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 14px;
            background-color: #FFFFFF;
            height: 34px;
        }
        #text-editor-toolbar button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 34px;
        }
        #text-editor-toolbar button:hover {
            background-color: #F3F4F6;
        }
        .draggable-text {
            position: absolute;
            cursor: move;
            padding: 10px;
            border: 2px dashed transparent;
            transition: border-color 0.3s;
            border-radius: 8px;
            z-index: 20; /* Garante que o texto fique sobre o carrossel */
        }
        .draggable-text:hover, .draggable-text.selected {
            border-color: rgba(236, 72, 153, 0.7); /* pink-500 com opacidade */
        }
        .alignment-guide {
            position: absolute;
            background-color: rgba(236, 72, 153, 0.7);
            z-index: 99;
            display: none;
        }
        #vertical-guide { width: 1px; height: 100%; top: 0; }
        #horizontal-guide { height: 1px; width: 100%; left: 0; }

        /* Estilos do Carrossel (Swiper) */
        .header-swiper {
            width: 100%;
            height: 100%; /* Ocupa toda a altura da seção */
        }
        .header-swiper .swiper-slide {
            text-align: center;
            font-size: 18px;
            background: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .header-swiper .swiper-slide img {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .header-swiper .swiper-button-next, .header-swiper .swiper-button-prev {
            color: white;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
        }
        .header-swiper .swiper-pagination-bullet-active {
            background: white;
        }

        /* Estilos da Pré-visualização e Templates */
        #event-page-preview {
            --font-display: 'Playfair Display', serif;
            --font-body: 'Cormorant Garamond', serif;
            transition: background-color 0.5s ease;
        }
        #event-page-preview .font-display { font-family: var(--font-display); }
        #event-page-preview .font-body { font-family: var(--font-body); }
        .section-graphic { display: block; margin: 0 auto 1rem; width: 4rem; height: 2.5rem;}

        /* Estilos de Dark Mode */
        #event-page-preview.dark {
            background-color: #111827; /* Fundo principal escuro */
        }
        #event-page-preview.dark .section-preview {
             /* Cores padrão para seções no modo escuro, podem ser sobrescritas pelo usuário */
            background-color: #1F2937 !important;
            color: #D1D5DB !important;
        }
        #event-page-preview.dark .section-preview h2,
        #event-page-preview.dark .section-preview h3 {
            color: #F9A8D4 !important; /* Cor de destaque para títulos */
        }
        #event-page-preview.dark .section-preview a {
            color: #FBCFE8 !important;
        }

        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .editable-section { position: relative; border: 2px dashed transparent; transition: all 0.3s; }
        .editable-section:hover { border-color: #F472B6; }
        .edit-btn { position: absolute; top: 1rem; right: 1rem; background-color: white; color: #4B5563; border-radius: 9999px; padding: 0.5rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; transition: all 0.2s; z-index: 30; }
        .edit-btn:hover { background-color: #EC4899; color: white; transform: scale(1.1); }
        
        .modal { position: fixed; inset: 0; background-color: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 50; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .modal.is-open { opacity: 1; visibility: visible; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 0.75rem; width: 90%; max-width: 50rem; max-height: 90vh; overflow-y: auto; transform: scale(0.95); transition: transform 0.3s; }
        .modal.is-open .modal-content { transform: scale(1); }

        .icon-card { cursor: pointer; border: 2px solid #E5E7EB; border-radius: 0.5rem; overflow: hidden; transition: all 0.2s ease-in-out; }
        .icon-card:hover { border-color: #DB2777; transform: translateY(-5px); box-shadow: 0 4px 10px rgba(0,0,0,0.08); }
        .icon-card.active { border-color: #DB2777; border-width: 3px; background-color: #FDF2F8; }
        .icon-card svg { width: 2.5rem; height: 2.5rem; margin: auto; color: #4B5563; }
        .icon-card.active svg { color: #DB2777; }
        
        /* Estilo do Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #EC4899; }
        .toggle-checkbox:checked + .toggle-label { background-color: #EC4899; }

        #toast-notification {
            transition: transform 0.5s ease-in-out;
        }
    </style>
</head>
<body>

    <div id="loading-state" class="min-h-screen flex items-center justify-center">
        <p class="text-lg text-gray-500">A carregar o editor da sua página...</p>
    </div>

    <div id="page-content" class="hidden">
        <header class="flex items-center justify-between h-16 px-6 bg-white border-b sticky top-0 z-40">
            <span id="header-title" class="text-xl font-bold text-gray-800 font-display">Editor da Página</span>
            <div class="flex items-center gap-4">
                 <a id="view-public-page" href="#" target="_blank" class="text-sm text-pink-600 hover:underline font-semibold">Ver Página Pública</a>
                 <button id="open-appearance-modal" class="bg-white border border-gray-300 text-gray-700 font-semibold px-4 py-2 rounded-lg hover:bg-gray-100 transition-colors flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" /></svg>
                    Personalizar
                </button>
                <button id="open-icon-modal" class="bg-white border border-gray-300 text-gray-700 font-semibold px-4 py-2 rounded-lg hover:bg-gray-100 transition-colors flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>
                    Ícone
                </button>
                 <button id="save-button" class="bg-pink-500 text-white font-semibold px-4 py-2 rounded-lg hover:bg-pink-600 transition-colors flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6h5a2 2 0 012 2v7a2 2 0 01-2 2H4a2 2 0 01-2-2V8a2 2 0 012-2h5v5.586l-1.293-1.293zM9 4a1 1 0 012 0v2H9V4z" /></svg>
                    Salvar Alterações
                </button>
            </div>
        </header>

        <main class="p-4 sm:p-6 md:p-8 bg-gray-200">
            <div id="event-page-preview" class="max-w-4xl mx-auto bg-white shadow-lg rounded-lg overflow-hidden">
                
                <section id="header-section" class="editable-section relative text-center bg-gray-700 h-[60vh]">
                    <button class="edit-btn" data-modal="header-modal" title="Editar Cabeçalho e Fotos"><svg class="w-5 h-5 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" /></svg></button>
                    <div id="header-content-wrapper" class="relative w-full h-full">
                        <!-- O carrossel será inserido aqui pelo JS -->
                    </div>
                </section>

                <section id="story-section" class="editable-section section-preview p-8 md:p-16 text-center">
                    <!-- O conteúdo será renderizado aqui pelo JS -->
                </section>
                <section id="details-section" class="editable-section section-preview p-8 md:p-16">
                    <!-- O conteúdo será renderizado aqui pelo JS -->
                </section>
                <section id="rsvp-section" class="editable-section section-preview p-8 md:p-16 text-center">
                    <!-- O conteúdo será renderizado aqui pelo JS -->
                </section>
            </div>
        </main>
    </div>
    
    <div id="text-editor-toolbar" class="flex items-center">
        <select id="font-family-select">
            <option value="'Playfair Display', serif">Playfair Display</option>
            <option value="'Dancing Script', cursive">Dancing Script</option>
            <option value="'Cormorant Garamond', serif">Cormorant Garamond</option>
            <option value="'Montserrat', sans-serif">Montserrat</option>
            <option value="'Roboto', sans-serif">Roboto</option>
        </select>
        <input type="number" id="font-size-input" min="10" max="150" step="1" title="Tamanho da Fonte (px)">
        <input type="color" id="font-color-input" title="Cor da Fonte">
        <button id="center-h-btn" title="Centralizar Horizontalmente"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V8m10 8V8M4 12h16"></path></svg></button>
        <button id="center-v-btn" title="Centralizar Verticalmente"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7H8m8 10H8m-4-5h16"></path></svg></button>
        <button id="recenter-btn" title="Voltar ao Centro Padrão"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4h4m12 0h-4v4m0 8v4h4M4 16h4v4M12 4v16M4 12h16"></path></svg></button>
    </div>

    <div id="toast-notification" class="hidden fixed top-5 right-5 text-white px-6 py-3 rounded-lg shadow-lg z-50 transform translate-x-full">
        <p id="toast-message"></p>
    </div>

    <div id="modal-container">
        <!-- MODAL DE APARÊNCIA (NOVO) -->
        <div id="appearance-modal" class="modal"><div class="modal-content">
            <h3 class="text-xl font-bold mb-6">Personalizar Aparência</h3>
            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border mb-6">
                <span class="font-medium text-gray-700">Modo Noturno</span>
                <div class="relative inline-block w-10 mr-2 align-middle select-none">
                    <input type="checkbox" id="theme-mode-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer transition-all duration-300 ease-in-out"/>
                    <label for="theme-mode-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer transition-colors"></label>
                </div>
            </div>
            <div class="space-y-4">
                <div class="border p-4 rounded-md">
                    <h4 class="font-semibold mb-3 text-gray-800">Seção: Nossa História</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div><label for="story-bg-color" class="block text-sm mb-1">Fundo</label><input type="color" id="story-bg-color" class="w-full h-10 p-1 border rounded-md"></div>
                        <div><label for="story-title-color" class="block text-sm mb-1">Título</label><input type="color" id="story-title-color" class="w-full h-10 p-1 border rounded-md"></div>
                        <div><label for="story-text-color" class="block text-sm mb-1">Texto</label><input type="color" id="story-text-color" class="w-full h-10 p-1 border rounded-md"></div>
                    </div>
                </div>
                <div class="border p-4 rounded-md">
                    <h4 class="font-semibold mb-3 text-gray-800">Seção: Detalhes do Evento</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div><label for="details-bg-color" class="block text-sm mb-1">Fundo</label><input type="color" id="details-bg-color" class="w-full h-10 p-1 border rounded-md"></div>
                        <div><label for="details-title-color" class="block text-sm mb-1">Títulos</label><input type="color" id="details-title-color" class="w-full h-10 p-1 border rounded-md"></div>
                        <div><label for="details-text-color" class="block text-sm mb-1">Texto</label><input type="color" id="details-text-color" class="w-full h-10 p-1 border rounded-md"></div>
                    </div>
                </div>
                 <div class="border p-4 rounded-md">
                    <h4 class="font-semibold mb-3 text-gray-800">Seção: Confirmação de Presença</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div><label for="rsvp-bg-color" class="block text-sm mb-1">Fundo</label><input type="color" id="rsvp-bg-color" class="w-full h-10 p-1 border rounded-md"></div>
                        <div><label for="rsvp-title-color" class="block text-sm mb-1">Título</label><input type="color" id="rsvp-title-color" class="w-full h-10 p-1 border rounded-md"></div>
                        <div><label for="rsvp-text-color" class="block text-sm mb-1">Texto</label><input type="color" id="rsvp-text-color" class="w-full h-10 p-1 border rounded-md"></div>
                    </div>
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-8"><button type="button" class="modal-close-btn px-6 py-2 bg-pink-500 text-white rounded-md">Fechar</button></div>
        </div></div>

        <!-- Outros Modais -->
        <div id="icon-modal" class="modal"><div class="modal-content"><h3 class="text-xl font-bold mb-4">Escolha um Ícone para o seu Evento</h3><p class="text-gray-600 mb-6">Este ícone aparecerá como um detalhe gráfico nas seções da sua página.</p><div id="icon-selection-container" class="grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 lg:grid-cols-10 gap-4"></div><div class="flex justify-end gap-2 mt-8"><button type="button" class="modal-close-btn px-6 py-2 bg-pink-500 text-white rounded-md">Confirmar</button></div></div></div>
        <div id="header-modal" class="modal"><div class="modal-content">
            <h3 class="text-xl font-bold mb-6">Editar Cabeçalho e Carrossel</h3>
            <form id="header-form" class="space-y-6">
                <div><label for="couple-names-input" class="block text-sm font-medium text-gray-700 mb-1">Nomes (separados por vírgula)</label><input type="text" id="couple-names-input" class="w-full p-2 border border-gray-300 rounded-md"></div>
                <div><label for="event-date-input" class="block text-sm font-medium text-gray-700 mb-1">Texto da Data</label><input type="text" id="event-date-input" class="w-full p-2 border border-gray-300 rounded-md"></div>
                <div><label class="block text-sm font-medium text-gray-700 mb-1">Foto Principal (Primeiro slide)</label><div id="header-image-uploader" class="image-uploader"></div></div>
                <div class="border-t pt-6"><h4 class="text-md font-semibold text-gray-700 mb-2">Configurações do Carrossel</h4><div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border"><label for="gallery-autoplay" class="flex items-center gap-3 cursor-pointer"><input type="checkbox" id="gallery-autoplay" class="h-4 w-4 rounded text-pink-600 focus:ring-pink-500"><span>Ativar reprodução automática</span></label><div id="autoplay-duration-container" class="hidden items-center gap-2"><input type="number" id="gallery-duration" class="w-20 p-1 border border-gray-300 rounded-md" min="1" step="1"><label for="gallery-duration" class="text-sm text-gray-600">segundos</label></div></div></div>
                <div class="border-t pt-6"><h4 class="text-md font-semibold text-gray-700 mb-2">Fotos Adicionais do Carrossel</h4><div id="gallery-inputs-container" class="space-y-4 mb-4 max-h-60 overflow-y-auto pr-2"></div><button type="button" id="add-photo-btn" class="text-sm text-pink-600 font-semibold hover:text-pink-800 mb-4">+ Adicionar outra foto</button></div>
                <div class="flex justify-end gap-2 mt-6"><button type="button" class="modal-close-btn px-4 py-2 bg-gray-200 rounded-md">Cancelar</button><button type="submit" class="modal-save-btn px-4 py-2 bg-pink-500 text-white rounded-md">Salvar</button></div>
            </form>
        </div></div>
        <div id="story-modal" class="modal"><div class="modal-content"><h3 class="text-xl font-bold mb-4">Editar História</h3><form id="story-form" class="space-y-4"><div><label for="story-title-input" class="block text-sm font-medium text-gray-700 mb-1">Título da Seção</label><input type="text" id="story-title-input" class="w-full p-2 border border-gray-300 rounded-md"></div><div><label for="story-text-input" class="block text-sm font-medium text-gray-700 mb-1">Texto da História</label><textarea id="story-text-input" rows="8" class="w-full p-2 border border-gray-300 rounded-md"></textarea></div><div class="flex justify-end gap-2 mt-6"><button type="button" class="modal-close-btn px-4 py-2 bg-gray-200 rounded-md">Cancelar</button><button type="submit" class="modal-save-btn px-4 py-2 bg-pink-500 text-white rounded-md">Salvar</button></div></form></div></div>
        <div id="details-modal" class="modal"><div class="modal-content"><h3 class="text-xl font-bold mb-4">Editar Detalhes do Evento</h3><form id="details-form" class="space-y-6"><fieldset class="border p-4 rounded-md"><legend class="text-lg font-semibold px-2">Cerimónia</legend><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="ceremony-name" class="block text-sm font-medium text-gray-700 mb-1">Nome do Local</label><input type="text" id="ceremony-name" class="w-full p-2 border border-gray-300 rounded-md"></div><div><label for="ceremony-time" class="block text-sm font-medium text-gray-700 mb-1">Data e Hora</label><input type="text" id="ceremony-time" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Ex: Sábado, 25 de Outubro de 2025, às 16:00"></div></div><div class="mt-4"><label for="ceremony-address" class="block text-sm font-medium text-gray-700 mb-1">Endereço</label><input type="text" id="ceremony-address" class="w-full p-2 border border-gray-300 rounded-md"></div><div class="mt-4"><label for="ceremony-map" class="block text-sm font-medium text-gray-700 mb-1">URL do Google Maps</label><input type="url" id="ceremony-map" class="w-full p-2 border border-gray-300 rounded-md"></div></fieldset><fieldset class="border p-4 rounded-md"><legend class="text-lg font-semibold px-2">Recepção</legend><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="reception-name" class="block text-sm font-medium text-gray-700 mb-1">Nome do Local</label><input type="text" id="reception-name" class="w-full p-2 border border-gray-300 rounded-md"></div><div><label for="reception-time" class="block text-sm font-medium text-gray-700 mb-1">Hora</label><input type="text" id="reception-time" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Ex: Logo após a cerimónia"></div></div><div class="mt-4"><label for="reception-address" class="block text-sm font-medium text-gray-700 mb-1">Endereço</label><input type="text" id="reception-address" class="w-full p-2 border border-gray-300 rounded-md"></div><div class="mt-4"><label for="reception-map" class="block text-sm font-medium text-gray-700 mb-1">URL do Google Maps</label><input type="url" id="reception-map" class="w-full p-2 border border-gray-300 rounded-md"></div></fieldset><div class="flex justify-end gap-2 mt-6"><button type="button" class="modal-close-btn px-4 py-2 bg-gray-200 rounded-md">Cancelar</button><button type="submit" class="modal-save-btn px-4 py-2 bg-pink-500 text-white rounded-md">Salvar</button></div></form></div></div>
        <div id="rsvp-modal" class="modal"><div class="modal-content"><h3 class="text-xl font-bold mb-4">Editar Confirmação de Presença</h3><form id="rsvp-form" class="space-y-4"><div><label for="rsvp-title-input" class="block text-sm font-medium text-gray-700 mb-1">Título da Seção</label><input type="text" id="rsvp-title-input" class="w-full p-2 border border-gray-300 rounded-md"></div><div><label for="rsvp-text-input" class="block text-sm font-medium text-gray-700 mb-1">Texto de Apoio</label><textarea id="rsvp-text-input" rows="4" class="w-full p-2 border border-gray-300 rounded-md"></textarea></div><div><label for="rsvp-button-text-input" class="block text-sm font-medium text-gray-700 mb-1">Texto do Botão</label><input type="text" id="rsvp-button-text-input" class="w-full p-2 border border-gray-300 rounded-md"></div><div><label for="rsvp-button-link-input" class="block text-sm font-medium text-gray-700 mb-1">Link do Botão (para seu formulário de RSVP)</label><input type="url" id="rsvp-button-link-input" class="w-full p-2 border border-gray-300 rounded-md" placeholder="https://seu-link-de-rsvp.com"></div><div class="flex justify-end gap-2 mt-6"><button type="button" class="modal-close-btn px-4 py-2 bg-gray-200 rounded-md">Cancelar</button><button type="submit" class="modal-save-btn px-4 py-2 bg-pink-500 text-white rounded-md">Salvar</button></div></form></div></div>
    </div>

    <!-- JS do Swiper.js para o Carrossel -->
    <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>

    <script type="module">
        import { auth, onAuthStateChanged, db, storage, ref, uploadBytes, getDownloadURL } from './auth.js';
        import { doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { iconLibrary } from './icon-library.js?v=2';

        // --- ELEMENTOS DA UI ---
        const pageContent = document.getElementById('page-content');
        const loadingState = document.getElementById('loading-state');
        const saveButton = document.getElementById('save-button');
        const headerContentWrapper = document.getElementById('header-content-wrapper');
        const verticalGuide = document.getElementById('vertical-guide');
        const horizontalGuide = document.getElementById('horizontal-guide');
        const eventPagePreview = document.getElementById('event-page-preview');

        // --- DADOS E ESTADO ---
        let currentUser;
        let pageData = {};
        let headerSwiper = null;

        const defaultData = {
            template: 'classic', // Mantido para fontes e layout base
            themeMode: 'light', // 'light' ou 'dark'
            sectionStyles: {
                story: { background: '#f8f7f5', title: '#831843', text: '#37322F' },
                details: { background: '#ffffff', title: '#831843', text: '#4b5563' },
                rsvp: { background: '#f8f7f5', title: '#831843', text: '#37322F' }
            },
            icon: iconLibrary.find(i => i.id === 'flower-2').svg,
            header: { 
                coupleNames: ["Noiva & Noivo"], 
                eventDate: "Data do Evento", 
                imageUrl: "https://images.unsplash.com/photo-1523438885200-e635ba2c371e?q=80&w=1200&auto=format&fit=crop",
                titleStyle: { fontFamily: "'Playfair Display', serif", fontSize: "60px", color: "#FFFFFF", top: "50%", left: "50%", transform: "translate(-50%, -50%)" },
                dateStyle: { fontFamily: "'Inter', sans-serif", fontSize: "20px", color: "#FFFFFF", top: "65%", left: "50%", transform: "translate(-50%, -50%)" }
            },
            story: { title: "Nossa História", text: "Clique no botão de edição para contar a sua história de amor..." },
            gallery: { photos: [], autoplay: false, duration: 5 },
            details: { ceremony: { name: "Local da Cerimônia", address: "Endereço, 123", time: "Sábado, 25 de Outubro de 2025, às 16:00", mapUrl: "#" }, reception: { name: "Local da Recepção", address: "Endereço, 456", time: "Logo após a cerimónia", mapUrl: "#" } },
            rsvp: { title: "Confirme sua Presença", text: "Sua presença é o nosso maior presente!", buttonText: "Confirmar Presença", buttonLink: "#" }
        };

        // --- INICIALIZAÇÃO E AUTENTICAÇÃO ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('view-public-page').href = `/convite.html?user=${user.uid}`;
                await loadPageData();
                initializePage();
            } else {
                window.location.href = '/login.html';
            }
        });

        async function loadPageData() {
            const pageDataRef = doc(db, 'users', currentUser.uid, 'eventPage', 'details');
            const docSnap = await getDoc(pageDataRef);
            if (docSnap.exists()) {
                const loadedData = docSnap.data();
                // Merge profundo para garantir que todas as chaves existam
                pageData = {
                    ...JSON.parse(JSON.stringify(defaultData)),
                    ...loadedData,
                    header: { ...defaultData.header, ...(loadedData.header || {}), titleStyle: { ...defaultData.header.titleStyle, ...(loadedData.header?.titleStyle || {}) }, dateStyle: { ...defaultData.header.dateStyle, ...(loadedData.header?.dateStyle || {}) } },
                    gallery: { ...defaultData.gallery, ...(loadedData.gallery || {}) },
                    sectionStyles: { ...defaultData.sectionStyles, ...(loadedData.sectionStyles || {}),
                        story: {...defaultData.sectionStyles.story, ...(loadedData.sectionStyles?.story || {})},
                        details: {...defaultData.sectionStyles.details, ...(loadedData.sectionStyles?.details || {})},
                        rsvp: {...defaultData.sectionStyles.rsvp, ...(loadedData.sectionStyles?.rsvp || {})},
                    }
                };
            } else {
                pageData = JSON.parse(JSON.stringify(defaultData));
                await setDoc(pageDataRef, pageData);
            }
        }

        function initializePage() {
            loadingState.classList.add('hidden');
            pageContent.classList.remove('hidden');
            renderAllPreviews();
            setupEventListeners();
            populateIconModal();
            setupAppearanceModal();
        }
        
        // --- LÓGICA DO EDITOR DE TEXTO FLUTUANTE ---
        const toolbar = document.getElementById('text-editor-toolbar');
        const fontFamilySelect = document.getElementById('font-family-select');
        const fontSizeInput = document.getElementById('font-size-input');
        const fontColorInput = document.getElementById('font-color-input');
        const centerHBtn = document.getElementById('center-h-btn');
        const centerVBtn = document.getElementById('center-v-btn');
        const recenterBtn = document.getElementById('recenter-btn');
        let selectedTextElement = null;

        function showToolbarFor(element) {
            if (selectedTextElement) selectedTextElement.classList.remove('selected');
            selectedTextElement = element;
            selectedTextElement.classList.add('selected');
            const rect = element.getBoundingClientRect();
            const containerRect = headerContentWrapper.getBoundingClientRect();
            toolbar.style.display = 'flex';
            toolbar.style.top = `${rect.top - containerRect.top - toolbar.offsetHeight - 10}px`;
            toolbar.style.left = `${rect.left - containerRect.left + (rect.width / 2) - (toolbar.offsetWidth / 2)}px`;
            fontFamilySelect.value = element.style.fontFamily;
            fontSizeInput.value = parseInt(element.style.fontSize, 10);
            fontColorInput.value = rgbToHex(element.style.color);
        }

        function hideToolbar() {
            toolbar.style.display = 'none';
            if (selectedTextElement) {
                selectedTextElement.classList.remove('selected');
                selectedTextElement = null;
            }
        }
        
        function updateSelectedTextStyle() {
            if (!selectedTextElement) return;
            const styleKey = selectedTextElement.id === 'couple-names-preview' ? 'titleStyle' : 'dateStyle';
            selectedTextElement.style.fontFamily = fontFamilySelect.value;
            selectedTextElement.style.fontSize = `${fontSizeInput.value}px`;
            selectedTextElement.style.color = fontColorInput.value;
            pageData.header[styleKey].fontFamily = fontFamilySelect.value;
            pageData.header[styleKey].fontSize = `${fontSizeInput.value}px`;
            pageData.header[styleKey].color = fontColorInput.value;
        }

        function setupDraggableText() {
            const draggables = document.querySelectorAll('.draggable-text');
            const snapThreshold = 5;
            draggables.forEach(el => {
                let isDragging = false, offsetX, offsetY;
                const handleDragStart = (e) => {
                    isDragging = true;
                    const event = e.touches ? e.touches[0] : e;
                    offsetX = event.clientX - el.getBoundingClientRect().left;
                    offsetY = event.clientY - el.getBoundingClientRect().top;
                    showToolbarFor(el);
                    e.stopPropagation();
                };

                const handleDragMove = (e) => {
                    if (!isDragging) return;
                    e.preventDefault();
                    const event = e.touches ? e.touches[0] : e;
                    const containerRect = headerContentWrapper.getBoundingClientRect();
                    let newLeft = event.clientX - containerRect.left - offsetX;
                    let newTop = event.clientY - containerRect.top - offsetY;
                    const elCenterH = newLeft + el.offsetWidth / 2;
                    const elCenterV = newTop + el.offsetHeight / 2;
                    const containerCenterH = containerRect.width / 2;
                    const containerCenterV = containerRect.height / 2;

                    if (Math.abs(elCenterH - containerCenterH) < snapThreshold) {
                        newLeft = containerCenterH - el.offsetWidth / 2;
                        verticalGuide.style.left = `${containerCenterH}px`;
                        verticalGuide.style.display = 'block';
                    } else {
                        verticalGuide.style.display = 'none';
                    }
                    if (Math.abs(elCenterV - containerCenterV) < snapThreshold) {
                        newTop = containerCenterV - el.offsetHeight / 2;
                        horizontalGuide.style.top = `${containerCenterV}px`;
                        horizontalGuide.style.display = 'block';
                    } else {
                        horizontalGuide.style.display = 'none';
                    }

                    newLeft = Math.max(0, Math.min(newLeft, containerRect.width - el.offsetWidth));
                    newTop = Math.max(0, Math.min(newTop, containerRect.height - el.offsetHeight));
                    el.style.left = `${newLeft}px`;
                    el.style.top = `${newTop}px`;
                    el.style.transform = 'none';
                };

                const handleDragEnd = () => {
                    if (!isDragging) return;
                    isDragging = false;
                    verticalGuide.style.display = 'none';
                    horizontalGuide.style.display = 'none';
                    const styleKey = el.id === 'couple-names-preview' ? 'titleStyle' : 'dateStyle';
                    pageData.header[styleKey].left = `${(el.offsetLeft / headerContentWrapper.offsetWidth) * 100}%`;
                    pageData.header[styleKey].top = `${(el.offsetTop / headerContentWrapper.offsetHeight) * 100}%`;
                    pageData.header[styleKey].transform = 'none';
                };

                el.addEventListener('mousedown', handleDragStart);
                document.addEventListener('mousemove', handleDragMove);
                document.addEventListener('mouseup', handleDragEnd);
                
                el.addEventListener('touchstart', handleDragStart);
                document.addEventListener('touchmove', handleDragMove, { passive: false });
                document.addEventListener('touchend', handleDragEnd);
            });
            document.addEventListener('click', (e) => {
                if (!toolbar.contains(e.target) && !e.target.classList.contains('draggable-text')) {
                    hideToolbar();
                }
            });
        }

        function centerElement(axis) {
            if (!selectedTextElement) return;
            const styleKey = selectedTextElement.id === 'couple-names-preview' ? 'titleStyle' : 'dateStyle';
            const defaultPositions = defaultData.header[styleKey];
            const currentTransform = selectedTextElement.style.transform;
            let [translateX, translateY] = [0, 0];
            if (currentTransform && currentTransform.includes('translate')) {
                [translateX, translateY] = currentTransform.match(/-?\d+(\.\d+)?%/g) || ['-50%', '-50%'];
            }
            
            if (axis === 'horizontal') {
                pageData.header[styleKey].left = '50%';
                pageData.header[styleKey].transform = `translate(-50%, ${translateY})`;
            } else if (axis === 'vertical') {
                pageData.header[styleKey].top = '50%';
                 pageData.header[styleKey].transform = `translate(${translateX}, -50%)`;
            } else if (axis === 'both') {
                pageData.header[styleKey].left = defaultPositions.left;
                pageData.header[styleKey].top = defaultPositions.top;
                pageData.header[styleKey].transform = defaultPositions.transform;
            }
            renderAllPreviews();
        }

        // --- RENDERIZAÇÃO E PRÉ-VISUALIZAÇÃO ---
        function renderAllPreviews() {
            const { header, story, details, gallery, rsvp, icon, themeMode, sectionStyles } = pageData;
            
            // Apply Theme
            eventPagePreview.classList.toggle('dark', themeMode === 'dark');

            // Render Header/Carousel
            const allPhotos = [header.imageUrl, ...(gallery.photos || []).map(p => p.url)];
            const slidesHtml = allPhotos.filter(url => url).map(url => `<div class="swiper-slide"><img src="${url}" onerror="this.src='https://placehold.co/800x600/FCE7F3/DB2777?text=Inválida'"/></div>`).join('');
            headerContentWrapper.innerHTML = `
                <div class="swiper header-swiper">
                    <div class="swiper-wrapper">${slidesHtml}</div>
                    <div class="swiper-pagination"></div>
                    <div class="swiper-button-next"></div>
                    <div class="swiper-button-prev"></div>
                </div>
                <div class="absolute inset-0 bg-black/20"></div>
                <div id="header-text-overlay" class="absolute inset-0">
                    <div id="vertical-guide" class="alignment-guide"></div>
                    <div id="horizontal-guide" class="alignment-guide"></div>
                    <h1 id="couple-names-preview" class="draggable-text"></h1>
                    <p id="event-date-preview" class="draggable-text"></p>
                </div>`;
            
            initializeHeaderCarousel();
            
            const titleEl = document.getElementById('couple-names-preview');
            const dateEl = document.getElementById('event-date-preview');
            titleEl.textContent = Array.isArray(header.coupleNames) ? header.coupleNames.join(' & ') : '';
            dateEl.textContent = header.eventDate;
            Object.assign(titleEl.style, header.titleStyle);
            Object.assign(dateEl.style, header.dateStyle);
            setupDraggableText();

            // Render Sections with custom styles
            const storySection = document.getElementById('story-section');
            storySection.innerHTML = `<button class="edit-btn" data-modal="story-modal" title="Editar Título e História"><svg class="w-5 h-5 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" /></svg></button> <div class="section-graphic">${icon || ''}</div> <h2 id="story-title-preview" class="font-display text-3xl md:text-4xl">${story.title}</h2> <p id="story-text-preview" class="font-body text-lg md:text-xl mt-6 max-w-2xl mx-auto leading-relaxed">${story.text}</p>`;
            storySection.style.backgroundColor = sectionStyles.story.background;
            storySection.querySelector('h2').style.color = sectionStyles.story.title;
            storySection.querySelector('p').style.color = sectionStyles.story.text;
            storySection.querySelector('.section-graphic').style.color = sectionStyles.story.title;

            const detailsSection = document.getElementById('details-section');
            detailsSection.innerHTML = `<button class="edit-btn" data-modal="details-modal" title="Editar Detalhes do Evento"><svg class="w-5 h-5 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" /></svg></button> <div class="section-graphic">${icon || ''}</div> <h2 class="font-display text-3xl md:text-4xl text-center mb-12">Detalhes do Evento</h2> <div class="grid grid-cols-1 md:grid-cols-2 gap-12 max-w-4xl mx-auto"> <div id="ceremony-details-preview" class="text-center"><h3 class="font-display text-2xl">Cerimónia</h3><p class="mt-2 font-semibold text-lg">${details.ceremony.name || ''}</p><p>${details.ceremony.address || ''}</p><p class="mt-1">${details.ceremony.time || ''}</p><a href="${details.ceremony.mapUrl || '#'}" target="_blank" class="mt-2 inline-block font-semibold hover:underline">Ver no mapa</a></div> <div id="reception-details-preview" class="text-center"><h3 class="font-display text-2xl">Recepção</h3><p class="mt-2 font-semibold text-lg">${details.reception.name || ''}</p><p>${details.reception.address || ''}</p><p class="mt-1">${details.reception.time || ''}</p><a href="${details.reception.mapUrl || '#'}" target="_blank" class="mt-2 inline-block font-semibold hover:underline">Ver no mapa</a></div> </div>`;
            detailsSection.style.backgroundColor = sectionStyles.details.background;
            detailsSection.querySelectorAll('h2, h3').forEach(el => el.style.color = sectionStyles.details.title);
            detailsSection.querySelectorAll('p, a').forEach(el => el.style.color = sectionStyles.details.text);
            detailsSection.querySelector('.section-graphic').style.color = sectionStyles.details.title;

            const rsvpSection = document.getElementById('rsvp-section');
            rsvpSection.innerHTML = `<button class="edit-btn" data-modal="rsvp-modal" title="Editar Confirmação de Presença"><svg class="w-5 h-5 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" /></svg></button> <div class="section-graphic">${icon || ''}</div> <h2 id="rsvp-title-preview" class="font-display text-3xl md:text-4xl">${rsvp.title}</h2> <p id="rsvp-text-preview" class="font-body text-lg md:text-xl mt-6 max-w-2xl mx-auto leading-relaxed">${rsvp.text}</p> <a id="rsvp-button-preview" href="${rsvp.buttonLink || '#'}" target="_blank" class="inline-block mt-8 px-8 py-3 text-white font-bold rounded-lg shadow-md hover:opacity-90 transition-opacity">${rsvp.buttonText}</a>`;
            rsvpSection.style.backgroundColor = sectionStyles.rsvp.background;
            rsvpSection.querySelector('h2').style.color = sectionStyles.rsvp.title;
            rsvpSection.querySelector('p').style.color = sectionStyles.rsvp.text;
            rsvpSection.querySelector('a').style.backgroundColor = sectionStyles.rsvp.title; // Botão usa a cor do título
            rsvpSection.querySelector('.section-graphic').style.color = sectionStyles.rsvp.title;
        }
        
        function initializeHeaderCarousel() {
            if (headerSwiper) headerSwiper.destroy(true, true);
            const swiperOptions = {
                loop: true,
                pagination: { el: '.swiper-pagination', clickable: true },
                navigation: { nextEl: '.swiper-button-next', prevEl: '.swiper-button-prev' },
            };
            if (pageData.gallery.autoplay && (pageData.gallery.photos.length > 0 || pageData.header.imageUrl !== defaultData.header.imageUrl)) {
                 swiperOptions.autoplay = {
                    delay: (pageData.gallery.duration || 5) * 1000,
                    disableOnInteraction: false,
                };
            }
            headerSwiper = new Swiper('.header-swiper', swiperOptions);
        }

        // --- EVENTOS E MANIPULADORES ---
        function setupEventListeners() {
            saveButton.addEventListener('click', handleFullSave);
            fontFamilySelect.addEventListener('change', updateSelectedTextStyle);
            fontSizeInput.addEventListener('input', updateSelectedTextStyle);
            fontColorInput.addEventListener('input', updateSelectedTextStyle);
            centerHBtn.addEventListener('click', () => centerElement('horizontal'));
            centerVBtn.addEventListener('click', () => centerElement('vertical'));
            recenterBtn.addEventListener('click', () => centerElement('both'));
            
            document.body.addEventListener('click', function(e) {
                const editBtn = e.target.closest('.edit-btn');
                if (editBtn) openModal(editBtn.dataset.modal);
                const closeModalBtn = e.target.closest('.modal-close-btn');
                if (closeModalBtn) closeModal(closeModalBtn.closest('.modal'));
                const openAppearanceBtn = e.target.closest('#open-appearance-modal');
                if(openAppearanceBtn) openModal('appearance-modal');
                const openIconBtn = e.target.closest('#open-icon-modal');
                if(openIconBtn) openModal('icon-modal');
            });

            document.getElementById('header-form').addEventListener('submit', handleHeaderFormSubmit);
            document.getElementById('story-form').addEventListener('submit', handleStoryFormSubmit);
            document.getElementById('details-form').addEventListener('submit', handleDetailsFormSubmit);
            document.getElementById('rsvp-form').addEventListener('submit', handleRsvpFormSubmit);
            document.getElementById('add-photo-btn').addEventListener('click', () => createGalleryUploader());
        }
        
        async function handleFullSave() {
            saveButton.disabled = true;
            saveButton.innerHTML = 'A salvar...';
            try {
                await setDoc(doc(db, 'users', currentUser.uid, 'eventPage', 'details'), pageData);
                showToast('Alterações salvas com sucesso!', false);
            } catch (error) {
                console.error("Erro ao salvar dados da página: ", error);
                showToast(`Erro ao salvar: ${error.message}`);
            } finally {
                saveButton.disabled = false;
                saveButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6h5a2 2 0 012 2v7a2 2 0 01-2 2H4a2 2 0 01-2-2V8a2 2 0 012-2h5v5.586l-1.293-1.293zM9 4a1 1 0 012 0v2H9V4z" /></svg> Salvar Alterações`;
            }
        }

        // --- LÓGICA DOS MODAIS ---
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            // Preencher modais com dados atuais
            if (modalId === 'header-modal') {
                document.getElementById('couple-names-input').value = pageData.header.coupleNames.join(', ');
                document.getElementById('event-date-input').value = pageData.header.eventDate;
                setupImageUploader('header-image-uploader', pageData.header.imageUrl);
                const autoplayCheck = document.getElementById('gallery-autoplay');
                const durationInput = document.getElementById('gallery-duration');
                const durationContainer = document.getElementById('autoplay-duration-container');
                autoplayCheck.checked = pageData.gallery.autoplay;
                durationInput.value = pageData.gallery.duration;
                durationContainer.style.display = pageData.gallery.autoplay ? 'flex' : 'none';
                autoplayCheck.onchange = () => { durationContainer.style.display = autoplayCheck.checked ? 'flex' : 'none'; };
                const galleryContainer = document.getElementById('gallery-inputs-container');
                galleryContainer.innerHTML = '';
                (pageData.gallery.photos || []).forEach((photo, index) => createGalleryUploader(photo.url, index));
            } else if (modalId === 'story-modal') {
                document.getElementById('story-title-input').value = pageData.story.title;
                document.getElementById('story-text-input').value = pageData.story.text;
            } else if (modalId === 'details-modal') {
                // Preencher campos de detalhes
                document.getElementById('ceremony-name').value = pageData.details.ceremony.name;
                document.getElementById('ceremony-time').value = pageData.details.ceremony.time;
                document.getElementById('ceremony-address').value = pageData.details.ceremony.address;
                document.getElementById('ceremony-map').value = pageData.details.ceremony.mapUrl;
                document.getElementById('reception-name').value = pageData.details.reception.name;
                document.getElementById('reception-time').value = pageData.details.reception.time;
                document.getElementById('reception-address').value = pageData.details.reception.address;
                document.getElementById('reception-map').value = pageData.details.reception.mapUrl;
            } else if (modalId === 'rsvp-modal') {
                document.getElementById('rsvp-title-input').value = pageData.rsvp.title;
                document.getElementById('rsvp-text-input').value = pageData.rsvp.text;
                document.getElementById('rsvp-button-text-input').value = pageData.rsvp.buttonText;
                document.getElementById('rsvp-button-link-input').value = pageData.rsvp.buttonLink;
            }
            modal.classList.add('is-open');
        }

        function closeModal(modal) {
            if (modal) modal.classList.remove('is-open');
        }

        function setupAppearanceModal() {
            const toggle = document.getElementById('theme-mode-toggle');
            toggle.checked = pageData.themeMode === 'dark';
            toggle.addEventListener('change', () => {
                pageData.themeMode = toggle.checked ? 'dark' : 'light';
                renderAllPreviews();
            });

            const colorInputs = [
                { id: 'story-bg-color', section: 'story', property: 'background' },
                { id: 'story-title-color', section: 'story', property: 'title' },
                { id: 'story-text-color', section: 'story', property: 'text' },
                { id: 'details-bg-color', section: 'details', property: 'background' },
                { id: 'details-title-color', section: 'details', property: 'title' },
                { id: 'details-text-color', section: 'details', property: 'text' },
                { id: 'rsvp-bg-color', section: 'rsvp', property: 'background' },
                { id: 'rsvp-title-color', section: 'rsvp', property: 'title' },
                { id: 'rsvp-text-color', section: 'rsvp', property: 'text' },
            ];

            colorInputs.forEach(inputInfo => {
                const inputEl = document.getElementById(inputInfo.id);
                inputEl.value = pageData.sectionStyles[inputInfo.section][inputInfo.property];
                inputEl.addEventListener('input', () => {
                    pageData.sectionStyles[inputInfo.section][inputInfo.property] = inputEl.value;
                    renderAllPreviews();
                });
            });
        }

        function populateIconModal() {
            const container = document.getElementById('icon-selection-container');
            container.innerHTML = '';
            iconLibrary.forEach(icon => {
                const card = document.createElement('div');
                card.className = 'icon-card p-4 flex items-center justify-center';
                card.dataset.iconId = icon.id;
                card.innerHTML = icon.svg;
                if (pageData.icon === icon.svg) card.classList.add('active');
                card.addEventListener('click', () => {
                    pageData.icon = icon.svg;
                    document.querySelectorAll('#icon-selection-container .icon-card').forEach(c => c.classList.remove('active'));
                    card.classList.add('active');
                    renderAllPreviews();
                });
                container.appendChild(card);
            });
        }
        
        // --- UPLOAD DE IMAGEM E SUBMISSÃO DE FORMULÁRIOS ---
        function setupImageUploader(containerId, currentUrl) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<img id="uploader-preview" src="${currentUrl}" class="w-full h-48 object-contain rounded-md mb-2 bg-gray-100 border" onerror="this.onerror=null;this.src='${defaultData.header.imageUrl}';"> <div class="flex items-center justify-between gap-2"> <label for="header-image-input" class="flex-grow text-center px-4 py-2 bg-white border border-gray-300 text-sm font-medium text-gray-700 rounded-md cursor-pointer hover:bg-gray-50"> Trocar Imagem </label> <input type="file" id="header-image-input" class="hidden" accept="image/jpeg, image/png, image/webp"> <button type="button" id="remove-image-btn" class="px-4 py-2 bg-red-100 border border-red-200 text-sm font-medium text-red-700 rounded-md hover:bg-red-200">Remover</button> </div>`;
            const fileInput = document.getElementById('header-image-input');
            const preview = document.getElementById('uploader-preview');
            const removeBtn = document.getElementById('remove-image-btn');
            fileInput.addEventListener('change', (e) => { if (e.target.files && e.target.files[0]) { preview.src = URL.createObjectURL(e.target.files[0]); } });
            removeBtn.addEventListener('click', () => { fileInput.value = ''; preview.src = defaultData.header.imageUrl; preview.dataset.shouldRemove = "true"; });
        }

        function createGalleryUploader(url = '', index = -1) {
            const container = document.getElementById('gallery-inputs-container');
            const uploaderId = `gallery-image-input-${Date.now()}`;
            const isNew = url === '';
            const placeholder = 'https://placehold.co/400x200/F3F4F6/9CA3AF?text=Nova+Foto';

            const div = document.createElement('div');
            div.className = 'flex items-center gap-2 gallery-item';
            div.dataset.index = index; div.dataset.url = url; 
            div.innerHTML = `<img src="${isNew ? placeholder : url}" class="w-24 h-16 object-cover rounded-md bg-gray-100 border"><div class="flex-grow"><label for="${uploaderId}" class="w-full text-center px-3 py-2 bg-white border border-gray-300 text-sm font-medium text-gray-700 rounded-md cursor-pointer hover:bg-gray-50">${isNew ? 'Selecionar Foto' : 'Trocar Foto'}</label><input type="file" id="${uploaderId}" class="hidden" accept="image/jpeg, image/png, image/webp"></div><button type="button" class="remove-gallery-item-btn p-2 text-red-500 hover:bg-red-100 rounded-full"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>`;
            const fileInput = div.querySelector('input[type="file"]');
            const previewImg = div.querySelector('img');
            fileInput.addEventListener('change', (e) => { if (e.target.files && e.target.files[0]) { previewImg.src = URL.createObjectURL(e.target.files[0]); div.dataset.file = 'true'; } });
            div.querySelector('.remove-gallery-item-btn').addEventListener('click', () => { div.remove(); });
            container.appendChild(div);
        }

        function handleStoryFormSubmit(e) { e.preventDefault(); pageData.story.title = document.getElementById('story-title-input').value; pageData.story.text = document.getElementById('story-text-input').value; renderAllPreviews(); closeModal(document.getElementById('story-modal')); }
        function handleDetailsFormSubmit(e) { e.preventDefault(); pageData.details.ceremony.name = document.getElementById('ceremony-name').value; pageData.details.ceremony.time = document.getElementById('ceremony-time').value; pageData.details.ceremony.address = document.getElementById('ceremony-address').value; pageData.details.ceremony.mapUrl = document.getElementById('ceremony-map').value; pageData.details.reception.name = document.getElementById('reception-name').value; pageData.details.reception.time = document.getElementById('reception-time').value; pageData.details.reception.address = document.getElementById('reception-address').value; pageData.details.reception.mapUrl = document.getElementById('reception-map').value; renderAllPreviews(); closeModal(document.getElementById('details-modal')); }
        function handleRsvpFormSubmit(e) { e.preventDefault(); pageData.rsvp.title = document.getElementById('rsvp-title-input').value; pageData.rsvp.text = document.getElementById('rsvp-text-input').value; pageData.rsvp.buttonText = document.getElementById('rsvp-button-text-input').value; pageData.rsvp.buttonLink = document.getElementById('rsvp-button-link-input').value; renderAllPreviews(); closeModal(document.getElementById('rsvp-modal')); }

        async function handleHeaderFormSubmit(e) {
            e.preventDefault();
            const saveBtn = e.target.querySelector('.modal-save-btn');
            saveBtn.disabled = true; saveBtn.textContent = 'A salvar...';
            try {
                pageData.header.coupleNames = document.getElementById('couple-names-input').value.split(',').map(n => n.trim());
                pageData.header.eventDate = document.getElementById('event-date-input').value;
                const mainFileInput = document.getElementById('header-image-input');
                const mainPreview = document.getElementById('uploader-preview');
                if (mainFileInput && mainFileInput.files[0]) {
                    const file = mainFileInput.files[0];
                    const imageRef = ref(storage, `users/${currentUser.uid}/eventPage/header_image`);
                    await uploadBytes(imageRef, file);
                    pageData.header.imageUrl = await getDownloadURL(imageRef);
                } else if (mainPreview.dataset.shouldRemove === "true") {
                    pageData.header.imageUrl = defaultData.header.imageUrl;
                }
                
                pageData.gallery.autoplay = document.getElementById('gallery-autoplay').checked;
                pageData.gallery.duration = parseInt(document.getElementById('gallery-duration').value, 10) || 5;

                const galleryItems = document.querySelectorAll('#gallery-inputs-container .gallery-item');
                const uploadPromises = [];
                const newPhotosData = new Array(galleryItems.length);

                galleryItems.forEach((item, index) => {
                    const fileInput = item.querySelector('input[type="file"]');
                    const hasNewFile = fileInput && fileInput.files[0];
                    const existingUrl = item.dataset.url;
                    if (hasNewFile) {
                        const file = fileInput.files[0];
                        const imageRef = ref(storage, `users/${currentUser.uid}/gallery/${Date.now()}-${file.name}`);
                        const uploadTask = uploadBytes(imageRef, file).then(() => getDownloadURL(imageRef));
                        uploadPromises.push(uploadTask.then(url => { newPhotosData[index] = { url }; }));
                    } else if (existingUrl && existingUrl !== 'undefined') {
                        newPhotosData[index] = { url: existingUrl };
                    }
                });
                await Promise.all(uploadPromises);
                pageData.gallery.photos = newPhotosData.filter(Boolean);
                renderAllPreviews();
                closeModal(document.getElementById('header-modal'));
            } catch (error) { console.error("Erro ao atualizar cabeçalho:", error); showToast("Erro ao carregar uma ou mais imagens.", true);
            } finally { saveBtn.disabled = false; saveBtn.textContent = 'Salvar'; const preview = document.getElementById('uploader-preview'); if(preview) preview.dataset.shouldRemove = "false"; }
        }

        // --- FUNÇÕES AUXILIARES ---
        function rgbToHex(rgb) { if (!rgb || !rgb.startsWith('rgb')) return '#000000'; let [r, g, b] = rgb.match(/\d+/g).map(Number); return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase(); }
        function showToast(message, isError = true) { const toast = document.getElementById('toast-notification'); const toastMessage = document.getElementById('toast-message'); toastMessage.textContent = message; toast.className = `fixed top-5 right-5 text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-transform transform-gpu`; toast.classList.add(isError ? 'bg-red-500' : 'bg-green-500'); toast.classList.remove('hidden', 'translate-x-full'); toast.classList.add('translate-x-0'); setTimeout(() => { toast.classList.remove('translate-x-0'); toast.classList.add('translate-x-full'); }, 4000); }

    </script>
</body>
</html>
