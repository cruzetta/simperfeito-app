<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor da Página do Evento - Sim, Perfeito</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Cormorant+Garamond:wght@400;600;700&family=Dancing+Script:wght@700&family=Montserrat:wght@400;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- CSS do Swiper.js para o Carrossel -->
    <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css" />
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F3F4F6; }

        /* Estilos do Editor de Texto Flutuante e Guias de Alinhamento */
        #text-editor-toolbar {
            position: absolute;
            display: none;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 8px;
            z-index: 100;
            gap: 4px;
        }
        #text-editor-toolbar select, #text-editor-toolbar input, #text-editor-toolbar button {
            border: 1px solid #D1D5DB;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 14px;
            background-color: #FFFFFF;
            height: 34px;
        }
        #text-editor-toolbar button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 34px;
        }
        #text-editor-toolbar button:hover {
            background-color: #F3F4F6;
        }
        .draggable-text {
            position: absolute;
            cursor: move;
            padding: 10px;
            border: 2px dashed transparent;
            transition: border-color 0.3s;
            border-radius: 8px;
            z-index: 20; /* Garante que o texto fique sobre o carrossel */
        }
        .draggable-text:hover, .draggable-text.selected {
            border-color: rgba(236, 72, 153, 0.7); /* pink-500 com opacidade */
        }
        .alignment-guide {
            position: absolute;
            background-color: rgba(236, 72, 153, 0.7);
            z-index: 99;
            display: none;
        }
        #vertical-guide { width: 1px; height: 100%; top: 0; }
        #horizontal-guide { height: 1px; width: 100%; left: 0; }

        /* Estilos do Carrossel (Swiper) */
        .header-swiper {
            width: 100%;
            height: 100%; /* Ocupa toda a altura da seção */
        }
        .header-swiper .swiper-slide {
            text-align: center;
            font-size: 18px;
            background: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .header-swiper .swiper-slide img {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .header-swiper .swiper-button-next, .header-swiper .swiper-button-prev {
            color: white;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
        }
        .header-swiper .swiper-pagination-bullet-active {
            background: white;
        }


        /* Outros estilos */
        #event-page-preview {
            --font-display: 'Playfair Display', serif;
            --font-body: 'Cormorant Garamond', serif;
            --font-special: 'Dancing Script', cursive;
            --color-primary: #DB2777;
            --color-background: #FDF2F8;
            --color-text-main: #1F2937;
            --color-text-light: #4B5563;
            transition: all 0.5s ease;
        }
        #event-page-preview .font-display { font-family: var(--font-display); }
        #event-page-preview .font-body { font-family: var(--font-body); }
        #event-page-preview .font-special { font-family: var(--font-special); }
        #event-page-preview .text-primary { color: var(--color-primary); }
        #event-page-preview .bg-primary-light { background-color: var(--color-background); }
        #event-page-preview .border-primary { border-color: var(--color-primary); }
        #event-page-preview .section-graphic { display: none; }
        #event-page-preview.template-elegancia .section-graphic,
        #event-page-preview.template-classic .section-graphic,
        #event-page-preview.template-romantic .section-graphic { 
            display: block; 
            margin: 0 auto 1rem; 
            color: var(--color-primary); 
        }
        #event-page-preview.template-modern .section-graphic { display: none; }
        #event-page-preview.template-elegancia #couple-names-preview { font-family: var(--font-display); }
        #event-page-preview.template-elegancia .section-title { font-family: var(--font-body); font-weight: 600; }
        #event-page-preview.template-classic { --font-display: 'Playfair Display', serif; --font-body: "'Cormorant Garamond', serif"; --color-primary: #831843; --color-background: #F8F7F5; --color-text-main: #37322F; }
        #event-page-preview.template-modern { --font-display: 'Inter', sans-serif; --font-body: "'Inter', sans-serif"; --color-primary: #111827; --color-background: #F9FAFB; --color-text-main: #1F2937; }
        #event-page-preview.template-modern #header-section h1 { font-weight: 700; }
        #event-page-preview.template-modern #story-section, #event-page-preview.template-modern #details-section { text-align: left; }
        #event-page-preview.template-modern .section-title { text-align: left; }
        #event-page-preview.template-romantic { --font-display: "'Dancing Script', cursive"; --font-body: "'Cormorant Garamond', serif"; --color-primary: #DB2777; --color-background: #FFF1F2; --color-text-main: #881337; }
        #event-page-preview.template-romantic #header-section { border-bottom: 4px solid var(--color-primary); }

        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .editable-section { position: relative; border: 2px dashed transparent; transition: border-color 0.3s; }
        .editable-section:hover { border-color: #F472B6; }
        .edit-btn { position: absolute; top: 1rem; right: 1rem; background-color: white; color: #4B5563; border-radius: 9999px; padding: 0.5rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; transition: all 0.2s; z-index: 30; }
        .edit-btn:hover { background-color: #EC4899; color: white; transform: scale(1.1); }
        
        .modal { position: fixed; inset: 0; background-color: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 50; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .modal.is-open { opacity: 1; visibility: visible; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 0.75rem; width: 90%; max-width: 50rem; max-height: 90vh; overflow-y: auto; transform: scale(0.95); transition: transform 0.3s; }
        .modal.is-open .modal-content { transform: scale(1); }

        .template-card, .icon-card { cursor: pointer; border: 2px solid #E5E7EB; border-radius: 0.5rem; overflow: hidden; transition: all 0.2s ease-in-out; }
        .template-card:hover, .icon-card:hover { border-color: var(--color-primary); transform: translateY(-5px); box-shadow: 0 4px 10px rgba(0,0,0,0.08); }
        .template-card.active, .icon-card.active { border-color: var(--color-primary); border-width: 3px; background-color: #FDF2F8; }
        .icon-card svg { width: 2.5rem; height: 2.5rem; margin: auto; color: #4B5563; }
        .icon-card.active svg { color: var(--color-primary); }

        .drop-zone { transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out; }
        .drop-zone.drag-over { background-color: #FCE7F3; border-color: #F472B6; }
        
        #toast-notification {
            transition: transform 0.5s ease-in-out;
        }
    </style>
</head>
<body>

    <div id="loading-state" class="min-h-screen flex items-center justify-center">
        <p class="text-lg text-gray-500">A carregar o editor da sua página...</p>
    </div>

    <div id="page-content" class="hidden">
        <header class="flex items-center justify-between h-16 px-6 bg-white border-b sticky top-0 z-40">
            <span id="header-title" class="text-xl font-bold text-gray-800 font-display">Editor da Página</span>
            <div class="flex items-center gap-4">
                 <a id="view-public-page" href="#" target="_blank" class="text-sm text-pink-600 hover:underline font-semibold">Ver Página Pública</a>
                 <button id="open-template-modal" class="bg-white border border-gray-300 text-gray-700 font-semibold px-4 py-2 rounded-lg hover:bg-gray-100 transition-colors flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z" /></svg>
                    Templates
                </button>
                <button id="open-icon-modal" class="bg-white border border-gray-300 text-gray-700 font-semibold px-4 py-2 rounded-lg hover:bg-gray-100 transition-colors flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>
                    Ícone
                </button>
                 <button id="save-button" class="bg-pink-500 text-white font-semibold px-4 py-2 rounded-lg hover:bg-pink-600 transition-colors flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6h5a2 2 0 012 2v7a2 2 0 01-2 2H4a2 2 0 01-2-2V8a2 2 0 012-2h5v5.586l-1.293-1.293zM9 4a1 1 0 012 0v2H9V4z" /></svg>
                    Salvar Alterações
                </button>
            </div>
        </header>

        <main class="p-4 sm:p-6 md:p-8 bg-gray-200">
            <div id="event-page-preview" class="max-w-4xl mx-auto bg-white shadow-lg rounded-lg overflow-hidden">
                
                <!-- SEÇÃO DO CABEÇALHO/CARROSSEL UNIFICADA -->
                <section id="header-section" class="editable-section relative text-center bg-gray-700 h-[60vh]">
                    <button class="edit-btn" data-modal="header-modal" title="Editar Cabeçalho e Fotos"><svg class="w-5 h-5 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" /></svg></button>
                    
                    <div id="header-content-wrapper" class="relative w-full h-full">
                        <!-- O carrossel será inserido aqui pelo JS -->
                        <div id="header-text-overlay" class="absolute inset-0">
                            <div id="vertical-guide" class="alignment-guide"></div>
                            <div id="horizontal-guide" class="alignment-guide"></div>
                            <h1 id="couple-names-preview" class="draggable-text text-white text-6xl" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">Nomes Aqui</h1>
                            <p id="event-date-preview" class="draggable-text text-white text-lg" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">Data do Evento</p>
                        </div>
                    </div>
                </section>

                <section id="story-section" class="editable-section p-8 md:p-16 text-center bg-primary-light">
                    <!-- O conteúdo será renderizado aqui pelo JS -->
                </section>
                <section id="details-section" class="editable-section p-8 md:p-16">
                    <!-- O conteúdo será renderizado aqui pelo JS -->
                </section>
                <section id="rsvp-section" class="editable-section p-8 md:p-16 text-center">
                    <!-- O conteúdo será renderizado aqui pelo JS -->
                </section>
            </div>
        </main>
    </div>
    
    <div id="text-editor-toolbar" class="flex items-center">
        <select id="font-family-select">
            <option value="'Playfair Display', serif">Playfair Display</option>
            <option value="'Dancing Script', cursive">Dancing Script</option>
            <option value="'Cormorant Garamond', serif">Cormorant Garamond</option>
            <option value="'Montserrat', sans-serif">Montserrat</option>
            <option value="'Roboto', sans-serif">Roboto</option>
        </select>
        <input type="number" id="font-size-input" min="10" max="150" step="1" title="Tamanho da Fonte (px)">
        <input type="color" id="font-color-input" title="Cor da Fonte">
        <button id="center-h-btn" title="Centralizar Horizontalmente"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V8m10 8V8M4 12h16"></path></svg></button>
        <button id="center-v-btn" title="Centralizar Verticalmente"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7H8m8 10H8m-4-5h16"></path></svg></button>
        <button id="recenter-btn" title="Voltar ao Centro Padrão"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4h4m12 0h-4v4m0 8v4h4M4 16h4v4M12 4v16M4 12h16"></path></svg></button>
    </div>

    <div id="toast-notification" class="hidden fixed top-5 right-5 text-white px-6 py-3 rounded-lg shadow-lg z-50 transform translate-x-full">
        <p id="toast-message"></p>
    </div>

    <div id="modal-container">
        <div id="icon-modal" class="modal"><div class="modal-content"><h3 class="text-xl font-bold mb-4">Escolha um Ícone para o seu Evento</h3><p class="text-gray-600 mb-6">Este ícone aparecerá como um detalhe gráfico nas seções da sua página.</p><div id="icon-selection-container" class="grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 lg:grid-cols-10 gap-4"></div><div class="flex justify-end gap-2 mt-8"><button type="button" class="modal-close-btn px-6 py-2 bg-pink-500 text-white rounded-md">Confirmar</button></div></div></div>
        <div id="template-modal" class="modal"><div class="modal-content"><h3 class="text-xl font-bold mb-4">Escolha um Template</h3><p class="text-gray-600 mb-6">Selecione um estilo visual para sua página. Todas as suas informações serão mantidas.</p><div id="template-selection-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6"><div class="template-card" data-template="classic"><div class="p-4 border-b text-center" style="background-color: #F8F7F5;"><h4 style="font-family: 'Playfair Display', serif; color: #831843; font-size: 1.5rem;">Clássico</h4></div><div class="p-4"><p class="text-sm text-gray-500">Elegante e atemporal.</p></div></div><div class="template-card" data-template="modern"><div class="p-4 border-b text-center" style="background-color: #F9FAFB;"><h4 style="font-family: 'Inter', sans-serif; color: #111827; font-size: 1.5rem; font-weight: 700;">Moderno</h4></div><div class="p-4"><p class="text-sm text-gray-500">Minimalista e limpo.</p></div></div><div class="template-card" data-template="romantic"><div class="p-4 border-b text-center" style="background-color: #FFF1F2;"><h4 style="font-family: 'Dancing Script', cursive; color: #DB2777; font-size: 1.5rem;">Romântico</h4></div><div class="p-4"><p class="text-sm text-gray-500">Delicado e sonhador.</p></div></div><div class="template-card" data-template="elegancia"><div class="p-4 border-b text-center" style="background-color: #F9FAFB;"><h4 style="font-family: 'Dancing Script', cursive; color: #374151; font-size: 1.5rem;">Elegância</h4></div><div class="p-4"><p class="text-sm text-gray-500">Sofisticado e refinado.</p></div></div></div><div class="flex justify-end gap-2 mt-8"><button type="button" class="modal-close-btn px-6 py-2 bg-gray-200 rounded-md">Fechar</button></div></div></div>
        
        <!-- MODAL DO CABEÇALHO ATUALIZADO PARA INCLUIR GALERIA -->
        <div id="header-modal" class="modal"><div class="modal-content">
            <h3 class="text-xl font-bold mb-6">Editar Cabeçalho e Carrossel</h3>
            <form id="header-form" class="space-y-6">
                <div>
                    <label for="couple-names-input" class="block text-sm font-medium text-gray-700 mb-1">Nomes (separados por vírgula)</label>
                    <input type="text" id="couple-names-input" class="w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="event-date-input" class="block text-sm font-medium text-gray-700 mb-1">Texto da Data</label>
                    <input type="text" id="event-date-input" class="w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Foto Principal (Primeiro slide do carrossel)</label>
                    <div id="header-image-uploader" class="image-uploader"></div>
                </div>
                <div class="border-t pt-6">
                    <h4 class="text-md font-semibold text-gray-700 mb-2">Configurações do Carrossel</h4>
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border">
                        <label for="gallery-autoplay" class="flex items-center gap-3 cursor-pointer">
                            <input type="checkbox" id="gallery-autoplay" class="h-4 w-4 rounded text-pink-600 focus:ring-pink-500">
                            <span>Ativar reprodução automática</span>
                        </label>
                        <div id="autoplay-duration-container" class="hidden items-center gap-2">
                            <input type="number" id="gallery-duration" class="w-20 p-1 border border-gray-300 rounded-md" min="1" step="1">
                            <label for="gallery-duration" class="text-sm text-gray-600">segundos</label>
                        </div>
                    </div>
                </div>
                <div class="border-t pt-6">
                    <h4 class="text-md font-semibold text-gray-700 mb-2">Fotos Adicionais do Carrossel</h4>
                    <div id="gallery-inputs-container" class="space-y-4 mb-4 max-h-60 overflow-y-auto pr-2"></div>
                    <button type="button" id="add-photo-btn" class="text-sm text-pink-600 font-semibold hover:text-pink-800 mb-4">+ Adicionar outra foto</button>
                </div>

                <div class="flex justify-end gap-2 mt-6">
                    <button type="button" class="modal-close-btn px-4 py-2 bg-gray-200 rounded-md">Cancelar</button>
                    <button type="submit" class="modal-save-btn px-4 py-2 bg-pink-500 text-white rounded-md">Salvar</button>
                </div>
            </form>
        </div></div>

        <div id="story-modal" class="modal"><div class="modal-content"><h3 class="text-xl font-bold mb-4">Editar História</h3><form id="story-form" class="space-y-4"><div><label for="story-title-input" class="block text-sm font-medium text-gray-700 mb-1">Título da Seção</label><input type="text" id="story-title-input" class="w-full p-2 border border-gray-300 rounded-md"></div><div><label for="story-text-input" class="block text-sm font-medium text-gray-700 mb-1">Texto da História</label><textarea id="story-text-input" rows="8" class="w-full p-2 border border-gray-300 rounded-md"></textarea></div><div class="flex justify-end gap-2 mt-6"><button type="button" class="modal-close-btn px-4 py-2 bg-gray-200 rounded-md">Cancelar</button><button type="submit" class="modal-save-btn px-4 py-2 bg-pink-500 text-white rounded-md">Salvar</button></div></form></div></div>
        
        <!-- MODAL DE DETALHES ATUALIZADO -->
        <div id="details-modal" class="modal"><div class="modal-content">
            <h3 class="text-xl font-bold mb-4">Editar Detalhes do Evento</h3>
            <form id="details-form" class="space-y-6">
                <fieldset class="border p-4 rounded-md">
                    <legend class="text-lg font-semibold px-2 flex items-center gap-2">
                        <label for="ceremony-title" class="text-sm font-medium text-gray-700">Título da Seção</label>
                        <input type="text" id="ceremony-title" class="w-full p-1 border border-gray-300 rounded-md text-base">
                    </legend>
                    <div class="space-y-4 mt-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label for="ceremony-name" class="block text-sm font-medium text-gray-700 mb-1">Nome do Local</label><input type="text" id="ceremony-name" class="w-full p-2 border border-gray-300 rounded-md"></div>
                            <div><label for="ceremony-time" class="block text-sm font-medium text-gray-700 mb-1">Data e Hora</label><input type="text" id="ceremony-time" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Ex: Sábado, 25 de Outubro de 2025, às 16:00"></div>
                        </div>
                        <div><label for="ceremony-address" class="block text-sm font-medium text-gray-700 mb-1">Endereço</label><input type="text" id="ceremony-address" class="w-full p-2 border border-gray-300 rounded-md"></div>
                        <!-- CORREÇÃO: type="url" para validação correta -->
                        <div><label for="ceremony-map" class="block text-sm font-medium text-gray-700 mb-1">URL do Google Maps (Opcional)</label><input type="url" id="ceremony-map" class="w-full p-2 border border-gray-300 rounded-md" placeholder="https://maps.app.goo.gl/exemplo"></div>
                    </div>
                </fieldset>
                
                <fieldset class="border p-4 rounded-md">
                     <legend class="text-lg font-semibold px-2 flex items-center gap-2">
                        <label for="reception-title" class="text-sm font-medium text-gray-700">Título da Seção</label>
                        <input type="text" id="reception-title" class="w-full p-1 border border-gray-300 rounded-md text-base">
                    </legend>
                    <div class="flex items-center my-4">
                        <input type="checkbox" id="same-location-checkbox" class="h-4 w-4 rounded border-gray-300 text-pink-600 focus:ring-pink-500">
                        <label for="same-location-checkbox" class="ml-2 block text-sm font-medium text-gray-900">A recepção será no mesmo local</label>
                    </div>
                    <div id="reception-fields-container" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label for="reception-name" class="block text-sm font-medium text-gray-700 mb-1">Nome do Local</label><input type="text" id="reception-name" class="w-full p-2 border border-gray-300 rounded-md"></div>
                            <div><label for="reception-time" class="block text-sm font-medium text-gray-700 mb-1">Hora</label><input type="text" id="reception-time" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Ex: Logo após a cerimónia"></div>
                        </div>
                        <div><label for="reception-address" class="block text-sm font-medium text-gray-700 mb-1">Endereço</label><input type="text" id="reception-address" class="w-full p-2 border border-gray-300 rounded-md"></div>
                        <!-- CORREÇÃO: type="url" para validação correta -->
                        <div><label for="reception-map" class="block text-sm font-medium text-gray-700 mb-1">URL do Google Maps (Opcional)</label><input type="url" id="reception-map" class="w-full p-2 border border-gray-300 rounded-md" placeholder="https://maps.app.goo.gl/exemplo"></div>
                    </div>
                </fieldset>

                <div class="flex justify-end gap-2 mt-6">
                    <button type="button" class="modal-close-btn px-4 py-2 bg-gray-200 rounded-md">Cancelar</button>
                    <button type="submit" class="modal-save-btn px-4 py-2 bg-pink-500 text-white rounded-md">Salvar</button>
                </div>
            </form>
        </div></div>

        <div id="rsvp-modal" class="modal"><div class="modal-content"><h3 class="text-xl font-bold mb-4">Editar Confirmação de Presença</h3><form id="rsvp-form" class="space-y-4"><div><label for="rsvp-title-input" class="block text-sm font-medium text-gray-700 mb-1">Título da Seção</label><input type="text" id="rsvp-title-input" class="w-full p-2 border border-gray-300 rounded-md"></div><div><label for="rsvp-text-input" class="block text-sm font-medium text-gray-700 mb-1">Texto de Apoio</label><textarea id="rsvp-text-input" rows="4" class="w-full p-2 border border-gray-300 rounded-md"></textarea></div><div><label for="rsvp-button-text-input" class="block text-sm font-medium text-gray-700 mb-1">Texto do Botão</label><input type="text" id="rsvp-button-text-input" class="w-full p-2 border border-gray-300 rounded-md"></div><div><label for="rsvp-button-link-input" class="block text-sm font-medium text-gray-700 mb-1">Link do Botão (para seu formulário de RSVP)</label><input type="url" id="rsvp-button-link-input" class="w-full p-2 border border-gray-300 rounded-md" placeholder="https://seu-link-de-rsvp.com"></div><div class="flex justify-end gap-2 mt-6"><button type="button" class="modal-close-btn px-4 py-2 bg-gray-200 rounded-md">Cancelar</button><button type="submit" class="modal-save-btn px-4 py-2 bg-pink-500 text-white rounded-md">Salvar</button></div></form></div></div>
    </div>

    <!-- JS do Swiper.js para o Carrossel -->
    <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>

    <script type="module">
        import { auth, onAuthStateChanged, db, storage, ref, uploadBytes, getDownloadURL } from './auth.js';
        import { doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { iconLibrary } from './icon-library.js?v=2';

        // --- ELEMENTOS DA UI ---
        const pageContent = document.getElementById('page-content');
        const loadingState = document.getElementById('loading-state');
        const saveButton = document.getElementById('save-button');
        const headerContentWrapper = document.getElementById('header-content-wrapper');
        const verticalGuide = document.getElementById('vertical-guide');
        const horizontalGuide = document.getElementById('horizontal-guide');
        const viewPublicPageLink = document.getElementById('view-public-page');

        // --- DADOS E ESTADO ---
        let currentUser;
        let pageData = {};
        let headerSwiper = null;

        const defaultData = {
            template: 'elegancia',
            icon: iconLibrary.find(i => i.id === 'flower-2').svg,
            header: { 
                coupleNames: ["Noiva & Noivo"], 
                eventDate: "Data do Evento", 
                imageUrl: "https://placehold.co/1200x600/F8F7F5/C7B2A4?text=Sua+Foto+Aqui",
                titleStyle: { fontFamily: "'Playfair Display', serif", fontSize: "60px", color: "#FFFFFF", top: "50%", left: "50%", transform: "translate(-50%, -50%)" },
                dateStyle: { fontFamily: "'Inter', sans-serif", fontSize: "20px", color: "#FFFFFF", top: "65%", left: "50%", transform: "translate(-50%, -50%)" }
            },
            story: { title: "Nossa História", text: "Clique no botão de edição para contar a sua história de amor..." },
            gallery: { 
                photos: [],
                autoplay: false,
                duration: 5 
            },
            details: { 
                sameLocation: false,
                ceremony: { title: "Cerimónia", name: "Local da Cerimônia", address: "Endereço, 123", time: "Sábado, 25 de Outubro de 2025, às 16:00", mapUrl: "" }, 
                reception: { title: "Recepção", name: "Local da Recepção", address: "Endereço, 456", time: "Logo após a cerimónia", mapUrl: "" } 
            },
            // CORREÇÃO: Removido o "#" do link padrão
            rsvp: { title: "Confirme sua Presença", text: "Sua presença é o nosso maior presente!", buttonText: "Confirmar Presença", buttonLink: "" }
        };

        // --- INICIALIZAÇÃO E AUTENTICAÇÃO ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                viewPublicPageLink.href = `/convite.html?user=${currentUser.uid}`;
                await loadPageData();
                initializePage();
            } else {
                window.location.href = '/login.html';
            }
        });

        async function loadPageData() {
            const pageDataRef = doc(db, 'users', currentUser.uid, 'eventPage', 'details');
            const docSnap = await getDoc(pageDataRef);
            if (docSnap.exists()) {
                const loadedData = docSnap.data();
                pageData = {
                    ...JSON.parse(JSON.stringify(defaultData)),
                    ...loadedData,
                    header: { ...defaultData.header, ...(loadedData.header || {}), titleStyle: { ...defaultData.header.titleStyle, ...(loadedData.header?.titleStyle || {}) }, dateStyle: { ...defaultData.header.dateStyle, ...(loadedData.header?.dateStyle || {}) } },
                    story: { ...defaultData.story, ...(loadedData.story || {}) },
                    gallery: { ...defaultData.gallery, ...(loadedData.gallery || {}) },
                    details: { ...defaultData.details, ...(loadedData.details || {}), ceremony: { ...defaultData.details.ceremony, ...(loadedData.details?.ceremony || {}) }, reception: { ...defaultData.details.reception, ...(loadedData.details?.reception || {}) } },
                    rsvp: { ...defaultData.rsvp, ...(loadedData.rsvp || {}) }
                };
            } else {
                pageData = JSON.parse(JSON.stringify(defaultData));
                await setDoc(pageDataRef, pageData);
            }
        }

        function initializePage() {
            loadingState.classList.add('hidden');
            pageContent.classList.remove('hidden');
            renderAllPreviews();
            setupEventListeners();
            populateIconModal();
        }
        
        // --- LÓGICA DO EDITOR DE TEXTO FLUTUANTE ---
        const toolbar = document.getElementById('text-editor-toolbar');
        const fontFamilySelect = document.getElementById('font-family-select');
        const fontSizeInput = document.getElementById('font-size-input');
        const fontColorInput = document.getElementById('font-color-input');
        const centerHBtn = document.getElementById('center-h-btn');
        const centerVBtn = document.getElementById('center-v-btn');
        const recenterBtn = document.getElementById('recenter-btn');
        let selectedTextElement = null;

        function showToolbarFor(element) {
            if (selectedTextElement) selectedTextElement.classList.remove('selected');
            selectedTextElement = element;
            selectedTextElement.classList.add('selected');
            const rect = element.getBoundingClientRect();
            const containerRect = headerContentWrapper.getBoundingClientRect();
            toolbar.style.display = 'flex';
            toolbar.style.top = `${rect.top - containerRect.top - toolbar.offsetHeight - 10}px`;
            toolbar.style.left = `${rect.left - containerRect.left + (rect.width / 2) - (toolbar.offsetWidth / 2)}px`;
            fontFamilySelect.value = element.style.fontFamily;
            fontSizeInput.value = parseInt(element.style.fontSize, 10);
            fontColorInput.value = rgbToHex(element.style.color);
        }

        function hideToolbar() {
            toolbar.style.display = 'none';
            if (selectedTextElement) {
                selectedTextElement.classList.remove('selected');
                selectedTextElement = null;
            }
        }
        
        function updateSelectedTextStyle() {
            if (!selectedTextElement) return;
            const styleKey = selectedTextElement.id === 'couple-names-preview' ? 'titleStyle' : 'dateStyle';
            selectedTextElement.style.fontFamily = fontFamilySelect.value;
            selectedTextElement.style.fontSize = `${fontSizeInput.value}px`;
            selectedTextElement.style.color = fontColorInput.value;
            pageData.header[styleKey].fontFamily = fontFamilySelect.value;
            pageData.header[styleKey].fontSize = `${fontSizeInput.value}px`;
            pageData.header[styleKey].color = fontColorInput.value;
        }

        function setupDraggableText() {
            const draggables = document.querySelectorAll('.draggable-text');
            const snapThreshold = 5;
            draggables.forEach(el => {
                let isDragging = false, offsetX, offsetY;
                el.addEventListener('mousedown', (e) => {
                    isDragging = true;
                    offsetX = e.clientX - el.getBoundingClientRect().left;
                    offsetY = e.clientY - el.getBoundingClientRect().top;
                    showToolbarFor(el);
                    e.stopPropagation();
                });
                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;
                    const containerRect = headerContentWrapper.getBoundingClientRect();
                    let newLeft = e.clientX - containerRect.left - offsetX;
                    let newTop = e.clientY - containerRect.top - offsetY;
                    const elCenterH = newLeft + el.offsetWidth / 2;
                    const elCenterV = newTop + el.offsetHeight / 2;
                    const containerCenterH = containerRect.width / 2;
                    const containerCenterV = containerRect.height / 2;
                    if (Math.abs(elCenterH - containerCenterH) < snapThreshold) {
                        newLeft = containerCenterH - el.offsetWidth / 2;
                        verticalGuide.style.left = `${containerCenterH}px`;
                        verticalGuide.style.display = 'block';
                    } else {
                        verticalGuide.style.display = 'none';
                    }
                    if (Math.abs(elCenterV - containerCenterV) < snapThreshold) {
                        newTop = containerCenterV - el.offsetHeight / 2;
                        horizontalGuide.style.top = `${containerCenterV}px`;
                        horizontalGuide.style.display = 'block';
                    } else {
                        horizontalGuide.style.display = 'none';
                    }
                    newLeft = Math.max(0, Math.min(newLeft, containerRect.width - el.offsetWidth));
                    newTop = Math.max(0, Math.min(newTop, containerRect.height - el.offsetHeight));
                    el.style.left = `${newLeft}px`;
                    el.style.top = `${newTop}px`;
                    el.style.transform = 'none';
                });
                document.addEventListener('mouseup', () => {
                    if (!isDragging) return;
                    isDragging = false;
                    verticalGuide.style.display = 'none';
                    horizontalGuide.style.display = 'none';
                    const styleKey = el.id === 'couple-names-preview' ? 'titleStyle' : 'dateStyle';
                    pageData.header[styleKey].left = `${(el.offsetLeft / headerContentWrapper.offsetWidth) * 100}%`;
                    pageData.header[styleKey].top = `${(el.offsetTop / headerContentWrapper.offsetHeight) * 100}%`;
                    pageData.header[styleKey].transform = 'none';
                });
            });
            document.addEventListener('click', (e) => {
                if (!toolbar.contains(e.target) && !e.target.classList.contains('draggable-text')) {
                    hideToolbar();
                }
            });
        }

        function centerElement(axis) {
            if (!selectedTextElement) return;
            const styleKey = selectedTextElement.id === 'couple-names-preview' ? 'titleStyle' : 'dateStyle';
            const defaultPositions = defaultData.header[styleKey];
            if (axis === 'horizontal') {
                pageData.header[styleKey].left = '50%';
                pageData.header[styleKey].transform = `translate(-50%, ${selectedTextElement.style.transform.split(',')[1] || '0%'})`;
            } else if (axis === 'vertical') {
                pageData.header[styleKey].top = defaultPositions.top;
                 pageData.header[styleKey].transform = `translate(${selectedTextElement.style.transform.split(',')[0] || '0%'}, -50%)`;
            } else if (axis === 'both') {
                pageData.header[styleKey].left = defaultPositions.left;
                pageData.header[styleKey].top = defaultPositions.top;
                pageData.header[styleKey].transform = defaultPositions.transform;
            }
            renderAllPreviews();
        }

        // --- RENDERIZAÇÃO E PRÉ-VISUALIZAÇÃO ---
        function renderAllPreviews() {
            const { header, story, details, gallery, rsvp, icon, template } = pageData;
            
            const preview = document.getElementById('event-page-preview');
            preview.className = 'max-w-4xl mx-auto bg-white shadow-lg rounded-lg overflow-hidden';
            preview.classList.add(`template-${template}`);

            const allPhotos = [header.imageUrl, ...(gallery.photos || []).map(p => p.url)];
            const slidesHtml = allPhotos.filter(Boolean).map(url => `<div class="swiper-slide"><img src="${url}" onerror="this.src='https://placehold.co/800x600/FCE7F3/DB2777?text=Inválida'"/></div>`).join('');
            headerContentWrapper.innerHTML = `
                <div class="swiper header-swiper">
                    <div class="swiper-wrapper">${slidesHtml}</div>
                    <div class="swiper-pagination"></div>
                    <div class="swiper-button-next"></div>
                    <div class="swiper-button-prev"></div>
                </div>
                <div id="header-text-overlay" class="absolute inset-0">
                    <div id="vertical-guide" class="alignment-guide"></div>
                    <div id="horizontal-guide" class="alignment-guide"></div>
                    <h1 id="couple-names-preview" class="draggable-text text-white text-6xl" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.5);"></h1>
                    <p id="event-date-preview" class="draggable-text text-white text-lg" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.5);"></p>
                </div>`;
            
            initializeHeaderCarousel();
            
            const titleEl = document.getElementById('couple-names-preview');
            const dateEl = document.getElementById('event-date-preview');
            titleEl.textContent = Array.isArray(header.coupleNames) ? header.coupleNames.join(' & ') : '';
            dateEl.textContent = header.eventDate;
            Object.assign(titleEl.style, header.titleStyle);
            Object.assign(dateEl.style, header.dateStyle);
            setupDraggableText();

            const storySection = document.getElementById('story-section');
            storySection.innerHTML = `<button class="edit-btn" data-modal="story-modal" title="Editar Título e História"><svg class="w-5 h-5 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" /></svg></button> <div class="section-graphic w-16 h-10">${icon || ''}</div> <h2 id="story-title-preview" class="section-title font-display text-3xl md:text-4xl text-primary">${story.title}</h2> <p id="story-text-preview" class="font-body text-lg md:text-xl mt-6 max-w-2xl mx-auto leading-relaxed" style="color: var(--color-text-light);">${story.text}</p>`;
            const detailsSection = document.getElementById('details-section');
            detailsSection.innerHTML = `<button class="edit-btn" data-modal="details-modal" title="Editar Detalhes do Evento"><svg class="w-5 h-5 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" /></svg></button> <div class="section-graphic w-16 h-10">${icon || ''}</div> <h2 class="section-title font-display text-3xl md:text-4xl text-primary text-center mb-12">Detalhes do Evento</h2> <div class="grid grid-cols-1 md:grid-cols-2 gap-12 max-w-4xl mx-auto"> <div id="ceremony-details-preview" class="text-center"><h3 class="font-display text-2xl text-primary">${details.ceremony.title}</h3><p class="mt-2 font-semibold text-lg" style="color: var(--color-text-main);">${details.ceremony.name || ''}</p><p style="color: var(--color-text-light);">${details.ceremony.address || ''}</p><p class="mt-1" style="color: var(--color-text-light);">${details.ceremony.time || ''}</p><a href="${details.ceremony.mapUrl || '#'}" target="_blank" class="mt-2 inline-block font-semibold text-primary hover:underline">Ver no mapa</a></div> <div id="reception-details-preview" class="text-center"><h3 class="font-display text-2xl text-primary">${details.reception.title}</h3><p class="mt-2 font-semibold text-lg" style="color: var(--color-text-main);">${details.reception.name || ''}</p><p style="color: var(--color-text-light);">${details.reception.address || ''}</p><p class="mt-1" style="color: var(--color-text-light);">${details.reception.time || ''}</p><a href="${details.reception.mapUrl || '#'}" target="_blank" class="mt-2 inline-block font-semibold text-primary hover:underline">Ver no mapa</a></div> </div>`;
            const rsvpSection = document.getElementById('rsvp-section');
            rsvpSection.innerHTML = `<button class="edit-btn" data-modal="rsvp-modal" title="Editar Confirmação de Presença"><svg class="w-5 h-5 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" /></svg></button> <div class="section-graphic w-16 h-10">${icon || ''}</div> <h2 id="rsvp-title-preview" class="section-title font-display text-3xl md:text-4xl text-primary">${rsvp.title}</h2> <p id="rsvp-text-preview" class="font-body text-lg md:text-xl mt-6 max-w-2xl mx-auto leading-relaxed" style="color: var(--color-text-light);">${rsvp.text}</p> <a id="rsvp-button-preview" href="${rsvp.buttonLink || '#'}" target="_blank" class="inline-block mt-8 px-8 py-3 bg-primary text-white font-bold rounded-lg shadow-md hover:opacity-90 transition-opacity" style="background-color: var(--color-primary);">${rsvp.buttonText}</a>`;
        }
        
        function initializeHeaderCarousel() {
            if (headerSwiper) {
                headerSwiper.destroy(true, true);
            }
            const swiperOptions = {
                loop: true,
                pagination: { el: '.swiper-pagination', clickable: true },
                navigation: { nextEl: '.swiper-button-next', prevEl: '.swiper-button-prev' },
            };
            if (pageData.gallery.autoplay && (pageData.gallery.photos.length > 0 || pageData.header.imageUrl !== defaultData.header.imageUrl)) {
                 swiperOptions.autoplay = {
                    delay: pageData.gallery.duration * 1000,
                    disableOnInteraction: false,
                };
            }
            headerSwiper = new Swiper('.header-swiper', swiperOptions);
        }

        // --- EVENTOS E MANIPULADORES ---
        function setupEventListeners() {
            saveButton.addEventListener('click', handleFullSave);
            fontFamilySelect.addEventListener('change', updateSelectedTextStyle);
            fontSizeInput.addEventListener('input', updateSelectedTextStyle);
            fontColorInput.addEventListener('input', updateSelectedTextStyle);
            centerHBtn.addEventListener('click', () => centerElement('horizontal'));
            centerVBtn.addEventListener('click', () => centerElement('vertical'));
            recenterBtn.addEventListener('click', () => centerElement('both'));
            
            document.getElementById('open-template-modal').addEventListener('click', () => openModal('template-modal'));
            document.getElementById('open-icon-modal').addEventListener('click', () => openModal('icon-modal'));

            document.getElementById('template-selection-container').addEventListener('click', (e) => {
                const card = e.target.closest('.template-card');
                if (!card) return;
                const templateId = card.dataset.template;
                pageData.template = templateId;
                renderAllPreviews();
                document.querySelectorAll('#template-selection-container .template-card').forEach(c => c.classList.remove('active'));
                card.classList.add('active');
            });

            document.body.addEventListener('click', function(e) {
                const editBtn = e.target.closest('.edit-btn');
                if (editBtn) openModal(editBtn.dataset.modal);
                const closeModalBtn = e.target.closest('.modal-close-btn');
                if (closeModalBtn) closeModal(closeModalBtn.closest('.modal'));
            });

            document.getElementById('header-form').addEventListener('submit', handleHeaderFormSubmit);
            document.getElementById('story-form').addEventListener('submit', handleStoryFormSubmit);
            document.getElementById('details-form').addEventListener('submit', handleDetailsFormSubmit);
            document.getElementById('rsvp-form').addEventListener('submit', handleRsvpFormSubmit);
            document.getElementById('add-photo-btn').addEventListener('click', () => createGalleryUploader());
        }
        
        async function handleFullSave() {
            saveButton.disabled = true;
            saveButton.innerHTML = 'A salvar...';
            try {
                await setDoc(doc(db, 'users', currentUser.uid, 'eventPage', 'details'), pageData, { merge: true });
                showToast('Alterações salvas com sucesso!', false);
            } catch (error) {
                console.error("Erro ao salvar dados da página: ", error);
                showToast(`Erro ao salvar: ${error.message}`);
            } finally {
                saveButton.disabled = false;
                saveButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6h5a2 2 0 012 2v7a2 2 0 01-2 2H4a2 2 0 01-2-2V8a2 2 0 012-2h5v5.586l-1.293-1.293zM9 4a1 1 0 012 0v2H9V4z" /></svg> Salvar Alterações`;
            }
        }

        // --- LÓGICA DOS MODAIS ---
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;

            if (modalId === 'header-modal') {
                document.getElementById('couple-names-input').value = pageData.header.coupleNames.join(', ');
                document.getElementById('event-date-input').value = pageData.header.eventDate;
                setupImageUploader('header-image-uploader', pageData.header.imageUrl);
                const autoplayCheck = document.getElementById('gallery-autoplay');
                const durationInput = document.getElementById('gallery-duration');
                const durationContainer = document.getElementById('autoplay-duration-container');
                autoplayCheck.checked = pageData.gallery.autoplay;
                durationInput.value = pageData.gallery.duration;
                durationContainer.style.display = pageData.gallery.autoplay ? 'flex' : 'none';
                autoplayCheck.onchange = () => { durationContainer.style.display = autoplayCheck.checked ? 'flex' : 'none'; };
                const galleryContainer = document.getElementById('gallery-inputs-container');
                galleryContainer.innerHTML = '';
                (pageData.gallery.photos || []).forEach((photo, index) => createGalleryUploader(photo.url, index));
            } else if (modalId === 'story-modal') {
                document.getElementById('story-title-input').value = pageData.story.title;
                document.getElementById('story-text-input').value = pageData.story.text;
            } else if (modalId === 'details-modal') {
                const { ceremony, reception, sameLocation } = pageData.details;
                document.getElementById('ceremony-title').value = ceremony.title;
                document.getElementById('ceremony-name').value = ceremony.name;
                document.getElementById('ceremony-time').value = ceremony.time;
                document.getElementById('ceremony-address').value = ceremony.address;
                // CORREÇÃO: Limpa o campo se o valor for "#"
                document.getElementById('ceremony-map').value = ceremony.mapUrl === '#' ? '' : ceremony.mapUrl;
                document.getElementById('reception-title').value = reception.title;
                document.getElementById('reception-name').value = reception.name;
                document.getElementById('reception-time').value = reception.time;
                document.getElementById('reception-address').value = reception.address;
                // CORREÇÃO: Limpa o campo se o valor for "#"
                document.getElementById('reception-map').value = reception.mapUrl === '#' ? '' : reception.mapUrl;
                
                const sameLocationCheckbox = document.getElementById('same-location-checkbox');
                sameLocationCheckbox.checked = sameLocation || false;
                sameLocationCheckbox.removeEventListener('change', toggleReceptionFields);
                sameLocationCheckbox.addEventListener('change', toggleReceptionFields);
                toggleReceptionFields();
            } else if (modalId === 'rsvp-modal') {
                document.getElementById('rsvp-title-input').value = pageData.rsvp.title;
                document.getElementById('rsvp-text-input').value = pageData.rsvp.text;
                document.getElementById('rsvp-button-text-input').value = pageData.rsvp.buttonText;
                // CORREÇÃO: Limpa o campo se o valor for "#"
                document.getElementById('rsvp-button-link-input').value = pageData.rsvp.buttonLink === '#' ? '' : pageData.rsvp.buttonLink;
            } else if (modalId === 'template-modal') {
                document.querySelectorAll('#template-selection-container .template-card').forEach(card => {
                    card.classList.toggle('active', card.dataset.template === pageData.template);
                });
            }
            
            modal.classList.add('is-open');
        }

        function closeModal(modal) {
            if (modal) modal.classList.remove('is-open');
        }

        function toggleReceptionFields() {
            const isChecked = document.getElementById('same-location-checkbox').checked;
            const container = document.getElementById('reception-fields-container');
            container.style.display = isChecked ? 'none' : 'block';
        }

        function populateIconModal() {
            const container = document.getElementById('icon-selection-container');
            container.innerHTML = '';
            iconLibrary.forEach(icon => {
                const card = document.createElement('div');
                card.className = 'icon-card p-4 flex items-center justify-center';
                card.dataset.iconId = icon.id;
                card.innerHTML = icon.svg;
                if (pageData.icon === icon.svg) card.classList.add('active');
                card.addEventListener('click', () => {
                    pageData.icon = icon.svg;
                    document.querySelectorAll('#icon-selection-container .icon-card').forEach(c => c.classList.remove('active'));
                    card.classList.add('active');
                    renderAllPreviews();
                });
                container.appendChild(card);
            });
        }
        
        function setupImageUploader(containerId, currentUrl) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<img id="uploader-preview" src="${currentUrl}" class="w-full h-48 object-contain rounded-md mb-2 bg-gray-100 border" onerror="this.onerror=null;this.src='${defaultData.header.imageUrl}';"> <div class="flex items-center justify-between gap-2"> <label for="header-image-input" class="flex-grow text-center px-4 py-2 bg-white border border-gray-300 text-sm font-medium text-gray-700 rounded-md cursor-pointer hover:bg-gray-50"> Trocar Imagem </label> <input type="file" id="header-image-input" class="hidden" accept="image/jpeg, image/png, image/webp"> <button type="button" id="remove-image-btn" class="px-4 py-2 bg-red-100 border border-red-200 text-sm font-medium text-red-700 rounded-md hover:bg-red-200">Remover</button> </div>`;
            const fileInput = document.getElementById('header-image-input');
            const preview = document.getElementById('uploader-preview');
            const removeBtn = document.getElementById('remove-image-btn');
            fileInput.addEventListener('change', (e) => { if (e.target.files && e.target.files[0]) { preview.src = URL.createObjectURL(e.target.files[0]); } });
            removeBtn.addEventListener('click', () => { fileInput.value = ''; preview.src = defaultData.header.imageUrl; preview.dataset.shouldRemove = "true"; });
        }

        function createGalleryUploader(url = '', index = -1) {
            const container = document.getElementById('gallery-inputs-container');
            const uploaderId = `gallery-image-input-${Date.now()}`;
            const isNew = url === '';
            const placeholder = 'https://placehold.co/400x200/F3F4F6/9CA3AF?text=Nova+Foto';

            const div = document.createElement('div');
            div.className = 'flex items-center gap-2 gallery-item';
            div.dataset.index = index;
            div.dataset.url = url;

            div.innerHTML = `
                <img src="${isNew ? placeholder : url}" class="w-24 h-16 object-cover rounded-md bg-gray-100 border">
                <div class="flex-grow">
                    <label for="${uploaderId}" class="w-full text-center px-3 py-2 bg-white border border-gray-300 text-sm font-medium text-gray-700 rounded-md cursor-pointer hover:bg-gray-50">
                        ${isNew ? 'Selecionar Foto' : 'Trocar Foto'}
                    </label>
                    <input type="file" id="${uploaderId}" class="hidden" accept="image/jpeg, image/png, image/webp">
                </div>
                <button type="button" class="remove-gallery-item-btn p-2 text-red-500 hover:bg-red-100 rounded-full">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                </button>
            `;

            const fileInput = div.querySelector('input[type="file"]');
            const previewImg = div.querySelector('img');

            fileInput.addEventListener('change', (e) => {
                if (e.target.files && e.target.files[0]) {
                    previewImg.src = URL.createObjectURL(e.target.files[0]);
                    div.dataset.file = 'true';
                }
            });

            div.querySelector('.remove-gallery-item-btn').addEventListener('click', () => {
                div.remove();
            });

            container.appendChild(div);
        }
        
        function handleStoryFormSubmit(e) {
            e.preventDefault();
            pageData.story.title = document.getElementById('story-title-input').value;
            pageData.story.text = document.getElementById('story-text-input').value;
            renderAllPreviews();
            closeModal(document.getElementById('story-modal'));
        }

        function handleDetailsFormSubmit(e) {
            e.preventDefault();
            const sameLocation = document.getElementById('same-location-checkbox').checked;
            pageData.details = {
                sameLocation: sameLocation,
                ceremony: {
                    title: document.getElementById('ceremony-title').value,
                    name: document.getElementById('ceremony-name').value,
                    time: document.getElementById('ceremony-time').value,
                    address: document.getElementById('ceremony-address').value,
                    mapUrl: document.getElementById('ceremony-map').value,
                },
                reception: {
                    title: document.getElementById('reception-title').value,
                    name: sameLocation ? '' : document.getElementById('reception-name').value,
                    time: document.getElementById('reception-time').value,
                    address: sameLocation ? '' : document.getElementById('reception-address').value,
                    mapUrl: sameLocation ? '' : document.getElementById('reception-map').value,
                }
            };
            renderAllPreviews();
            closeModal(document.getElementById('details-modal'));
        }

        function handleRsvpFormSubmit(e) {
            e.preventDefault();
            pageData.rsvp = {
                title: document.getElementById('rsvp-title-input').value,
                text: document.getElementById('rsvp-text-input').value,
                buttonText: document.getElementById('rsvp-button-text-input').value,
                buttonLink: document.getElementById('rsvp-button-link-input').value,
            };
            renderAllPreviews();
            closeModal(document.getElementById('rsvp-modal'));
        }

        async function handleHeaderFormSubmit(e) {
            e.preventDefault();
            const saveBtn = e.target.querySelector('.modal-save-btn');
            saveBtn.disabled = true; saveBtn.textContent = 'A salvar...';
            try {
                pageData.header.coupleNames = document.getElementById('couple-names-input').value.split(',').map(n => n.trim());
                pageData.header.eventDate = document.getElementById('event-date-input').value;
                const mainFileInput = document.getElementById('header-image-input');
                const mainPreview = document.getElementById('uploader-preview');
                if (mainFileInput && mainFileInput.files[0]) {
                    const file = mainFileInput.files[0];
                    const imageRef = ref(storage, `users/${currentUser.uid}/eventPage/header_image`);
                    await uploadBytes(imageRef, file);
                    pageData.header.imageUrl = await getDownloadURL(imageRef);
                } else if (mainPreview.dataset.shouldRemove === "true") {
                    pageData.header.imageUrl = defaultData.header.imageUrl;
                }
                
                pageData.gallery.autoplay = document.getElementById('gallery-autoplay').checked;
                pageData.gallery.duration = parseInt(document.getElementById('gallery-duration').value, 10) || 5;

                const galleryItems = document.querySelectorAll('#gallery-inputs-container .gallery-item');
                const uploadPromises = [];
                const newPhotosData = [];

                galleryItems.forEach((item, index) => {
                    const fileInput = item.querySelector('input[type="file"]');
                    const hasNewFile = fileInput && fileInput.files[0];
                    const existingUrl = item.dataset.url;

                    if (hasNewFile) {
                        const file = fileInput.files[0];
                        const imageRef = ref(storage, `users/${currentUser.uid}/gallery/${Date.now()}-${file.name}`);
                        const uploadTask = uploadBytes(imageRef, file).then(() => getDownloadURL(imageRef));
                        
                        uploadPromises.push(uploadTask.then(url => {
                            newPhotosData[index] = { url };
                        }));
                    } else if (existingUrl && existingUrl !== 'undefined') {
                        newPhotosData[index] = { url: existingUrl };
                    }
                });

                await Promise.all(uploadPromises);
                pageData.gallery.photos = newPhotosData.filter(Boolean);

                renderAllPreviews();
                closeModal(document.getElementById('header-modal'));
            } catch (error) { console.error("Erro ao atualizar cabeçalho:", error); showToast("Erro ao carregar uma ou mais imagens.", true);
            } finally { saveBtn.disabled = false; saveBtn.textContent = 'Salvar'; const preview = document.getElementById('uploader-preview'); if(preview) preview.dataset.shouldRemove = "false"; }
        }

        // --- FUNÇÕES AUXILIARES ---
        function rgbToHex(rgb) { if (!rgb || !rgb.startsWith('rgb')) return '#FFFFFF'; let [r, g, b] = rgb.match(/\d+/g).map(Number); return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase(); }
        function showToast(message, isError = true) { const toast = document.getElementById('toast-notification'); const toastMessage = document.getElementById('toast-message'); toastMessage.textContent = message; toast.className = `fixed top-5 right-5 text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-transform transform-gpu`; toast.classList.add(isError ? 'bg-red-500' : 'bg-green-500'); toast.classList.remove('hidden', 'translate-x-full'); toast.classList.add('translate-x-0'); setTimeout(() => { toast.classList.remove('translate-x-0'); toast.classList.add('translate-x-full'); }, 4000); }

    </script>
</body>
</html>
