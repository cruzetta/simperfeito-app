<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Página do Evento - Sim, Perfeito</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .font-display { font-family: 'Playfair Display', serif; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        #story-editor {
            min-height: 200px;
        }
    </style>
</head>
<body>

    <!-- Tela de Carregamento -->
    <div id="loading-state" class="min-h-screen flex items-center justify-center">
        <p class="text-lg text-gray-500">A carregar editor...</p>
    </div>

    <!-- Conteúdo da Página -->
    <div id="page-content" class="hidden fade-in">
        <header class="flex items-center justify-between h-16 px-6 bg-white border-b sticky top-0 z-20">
            <span id="header-title" class="text-xl font-bold text-gray-800 font-display">Página do Evento</span>
            <button id="save-button" class="bg-pink-500 text-white font-semibold px-4 py-2 rounded-lg hover:bg-pink-600 transition-colors flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6h5a2 2 0 012 2v7a2 2 0 01-2 2H4a2 2 0 01-2-2V8a2 2 0 012-2h5v5.586l-1.293-1.293zM9 4a1 1 0 012 0v2H9V4z" /></svg>
                Salvar Alterações
            </button>
        </header>

        <main class="p-4 sm:p-6 md:p-8">
            <div id="success-message" class="hidden bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded-md mb-6" role="alert">
                <p class="font-bold">Sucesso!</p>
                <p>As suas alterações foram salvas.</p>
            </div>

            <div class="bg-white p-6 sm:p-8 rounded-lg shadow-sm border">
                <form id="event-page-form" class="space-y-6">
                    <div>
                        <label for="page-title" class="block text-sm font-medium text-gray-700 mb-1">Título da Página</label>
                        <input type="text" id="page-title" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Ex: Nossa História de Amor">
                    </div>
                    <div>
                        <label for="image-url" class="block text-sm font-medium text-gray-700 mb-1">URL da Foto Principal</label>
                        <input type="url" id="image-url" class="w-full p-2 border border-gray-300 rounded-md" placeholder="https://exemplo.com/foto.jpg">
                    </div>
                    <div class="mt-4">
                        <img id="image-preview" src="" alt="Pré-visualização da imagem" class="hidden w-full max-w-lg mx-auto rounded-lg shadow-md">
                    </div>
                    <div>
                        <label for="story-editor" class="block text-sm font-medium text-gray-700 mb-1">Sua História / Mensagem</label>
                        <textarea id="story-editor" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Conte a sua história, dê as boas-vindas aos convidados..."></textarea>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { auth, onAuthStateChanged, db } from './auth.js';
        import { doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // Elementos da UI
        const loadingState = document.getElementById('loading-state');
        const pageContent = document.getElementById('page-content');
        const headerTitle = document.getElementById('header-title');
        const saveButton = document.getElementById('save-button');
        const successMessage = document.getElementById('success-message');
        
        // Campos do Formulário
        const form = document.getElementById('event-page-form');
        const pageTitleInput = document.getElementById('page-title');
        const imageUrlInput = document.getElementById('image-url');
        const imagePreview = document.getElementById('image-preview');
        const storyEditor = document.getElementById('story-editor');

        let currentUser;
        let eventConfig;

        // --- INICIALIZAÇÃO ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await loadEventConfig();
                await loadPageData();
                initializePage();
            } else {
                loadingState.innerHTML = '<p class="text-lg text-red-500">Erro de autenticação. Por favor, recarregue o painel.</p>';
            }
        });

        function initializePage() {
            loadingState.classList.add('hidden');
            pageContent.classList.remove('hidden');
            setupEventListeners();
            updateHeaderTitle();
        }

        async function loadEventConfig() {
            const configRef = doc(db, 'users', currentUser.uid, 'config', 'event');
            const configSnap = await getDoc(configRef);
            if (configSnap.exists()) {
                eventConfig = configSnap.data();
            } else {
                // Fallback caso a configuração não exista
                eventConfig = { type: 'outro' };
            }
        }

        async function loadPageData() {
            const pageDataRef = doc(db, 'users', currentUser.uid, 'eventPage', 'details');
            const docSnap = await getDoc(pageDataRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                pageTitleInput.value = data.title || '';
                imageUrlInput.value = data.imageUrl || '';
                storyEditor.value = data.story || '';
                updateImagePreview();
            }
        }

        function setupEventListeners() {
            saveButton.addEventListener('click', handleSave);
            imageUrlInput.addEventListener('input', updateImagePreview);
        }
        
        function updateHeaderTitle() {
            switch (eventConfig.type) {
                case 'casamento':
                    headerTitle.textContent = 'Página dos Noivos';
                    break;
                case 'aniversario_infantil':
                    headerTitle.textContent = 'Página do Aniversariante';
                    break;
                case 'formatura':
                    headerTitle.textContent = 'Página do Formando';
                    break;
                default:
                    headerTitle.textContent = 'Página do Evento';
            }
        }

        function updateImagePreview() {
            const url = imageUrlInput.value.trim();
            if (url) {
                imagePreview.src = url;
                imagePreview.classList.remove('hidden');
            } else {
                imagePreview.classList.add('hidden');
            }
        }

        async function handleSave() {
            saveButton.disabled = true;
            saveButton.textContent = 'A salvar...';

            const dataToSave = {
                title: pageTitleInput.value,
                imageUrl: imageUrlInput.value,
                story: storyEditor.value,
                updatedAt: new Date()
            };

            try {
                const pageDataRef = doc(db, 'users', currentUser.uid, 'eventPage', 'details');
                await setDoc(pageDataRef, dataToSave, { merge: true });
                
                successMessage.classList.remove('hidden');
                setTimeout(() => {
                    successMessage.classList.add('hidden');
                }, 3000);

            } catch (error) {
                console.error("Erro ao salvar dados da página: ", error);
                alert("Ocorreu um erro ao salvar. Tente novamente.");
            } finally {
                saveButton.disabled = false;
                saveButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6h5a2 2 0 012 2v7a2 2 0 01-2 2H4a2 2 0 01-2-2V8a2 2 0 012-2h5v5.586l-1.293-1.293zM9 4a1 1 0 012 0v2H9V4z" /></svg> Salvar Alterações`;
            }
        }
    </script>
</body>
</html>
