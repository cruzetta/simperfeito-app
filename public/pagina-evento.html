<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor da Página do Evento - Sim, Perfeito</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Cormorant+Garamond:wght@400;600;700&family=Dancing+Script:wght@700&family=Montserrat:wght@400;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F3F4F6; }

        /* Estilos do Editor de Texto Flutuante */
        #text-editor-toolbar {
            position: absolute;
            display: none;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 8px;
            z-index: 100;
            gap: 8px;
        }
        #text-editor-toolbar select, #text-editor-toolbar input {
            border: 1px solid #D1D5DB;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 14px;
        }
        .draggable-text {
            position: absolute;
            cursor: move;
            padding: 10px;
            border: 2px dashed transparent;
            transition: border-color 0.3s;
            border-radius: 8px;
        }
        .draggable-text:hover, .draggable-text.selected {
            border-color: rgba(236, 72, 153, 0.7); /* pink-500 com opacidade */
        }

        /* Outros estilos permanecem os mesmos */
        #event-page-preview {
            --font-display: 'Playfair Display', serif;
            --font-body: 'Cormorant Garamond', serif;
            --font-special: 'Dancing Script', cursive;
            --color-primary: #DB2777;
            --color-background: #FDF2F8;
            --color-text-main: #1F2937;
            --color-text-light: #4B5563;
            transition: all 0.5s ease;
        }
        #event-page-preview .font-display { font-family: var(--font-display); }
        #event-page-preview .font-body { font-family: var(--font-body); }
        #event-page-preview .font-special { font-family: var(--font-special); }
        #event-page-preview .text-primary { color: var(--color-primary); }
        #event-page-preview .bg-primary-light { background-color: var(--color-background); }
        #event-page-preview .border-primary { border-color: var(--color-primary); }
        #event-page-preview .section-graphic { display: none; }
        #event-page-preview.template-elegancia .section-graphic,
        #event-page-preview.template-classic .section-graphic,
        #event-page-preview.template-romantic .section-graphic { 
            display: block; 
            margin: 0 auto 1rem; 
            color: var(--color-primary); 
        }
        #event-page-preview.template-modern .section-graphic { display: none; }
        #event-page-preview.template-elegancia #couple-names-preview { font-family: var(--font-display); }
        #event-page-preview.template-elegancia .section-title { font-family: var(--font-body); font-weight: 600; }
        #event-page-preview.template-classic { --font-display: 'Playfair Display', serif; --font-body: "'Cormorant Garamond', serif"; --color-primary: #831843; --color-background: #F8F7F5; --color-text-main: #37322F; }
        #event-page-preview.template-modern { --font-display: 'Inter', sans-serif; --font-body: "'Inter', sans-serif"; --color-primary: #111827; --color-background: #F9FAFB; --color-text-main: #1F2937; }
        #event-page-preview.template-modern #header-section h1 { font-weight: 700; }
        #event-page-preview.template-modern #story-section, #event-page-preview.template-modern #details-section { text-align: left; }
        #event-page-preview.template-modern .section-title { text-align: left; }
        #event-page-preview.template-romantic { --font-display: "'Dancing Script', cursive"; --font-body: "'Cormorant Garamond', serif"; --color-primary: #DB2777; --color-background: #FFF1F2; --color-text-main: #881337; }
        #event-page-preview.template-romantic #header-section { border-bottom: 4px solid var(--color-primary); }

        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .editable-section { position: relative; border: 2px dashed transparent; transition: border-color 0.3s; }
        .editable-section:hover { border-color: #F472B6; }
        .edit-btn { position: absolute; top: 1rem; right: 1rem; background-color: white; color: #4B5563; border-radius: 9999px; padding: 0.5rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; transition: all 0.2s; z-index: 10; }
        .edit-btn:hover { background-color: #EC4899; color: white; transform: scale(1.1); }
        
        .modal { position: fixed; inset: 0; background-color: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 50; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .modal.is-open { opacity: 1; visibility: visible; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 0.75rem; width: 90%; max-width: 50rem; max-height: 90vh; overflow-y: auto; transform: scale(0.95); transition: transform 0.3s; }
        .modal.is-open .modal-content { transform: scale(1); }

        .template-card, .icon-card { cursor: pointer; border: 2px solid #E5E7EB; border-radius: 0.5rem; overflow: hidden; transition: all 0.2s ease-in-out; }
        .template-card:hover, .icon-card:hover { border-color: var(--color-primary); transform: translateY(-5px); box-shadow: 0 4px 10px rgba(0,0,0,0.08); }
        .template-card.active, .icon-card.active { border-color: var(--color-primary); border-width: 3px; background-color: #FDF2F8; }
        .icon-card svg { width: 2.5rem; height: 2.5rem; margin: auto; color: #4B5563; }
        .icon-card.active svg { color: var(--color-primary); }

        .drop-zone { transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out; }
        .drop-zone.drag-over { background-color: #FCE7F3; border-color: #F472B6; }
        
        #toast-notification {
            transition: transform 0.5s ease-in-out;
        }
    </style>
</head>
<body>

    <div id="loading-state" class="min-h-screen flex items-center justify-center">
        <p class="text-lg text-gray-500">A carregar o editor da sua página...</p>
    </div>

    <div id="page-content" class="hidden">
        <header class="flex items-center justify-between h-16 px-6 bg-white border-b sticky top-0 z-40">
            <span id="header-title" class="text-xl font-bold text-gray-800 font-display">Editor da Página</span>
            <div class="flex items-center gap-4">
                 <a id="view-public-page" href="#" target="_blank" class="text-sm text-pink-600 hover:underline font-semibold">Ver Página Pública</a>
                 <button id="open-template-modal" class="bg-white border border-gray-300 text-gray-700 font-semibold px-4 py-2 rounded-lg hover:bg-gray-100 transition-colors flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z" /></svg>
                    Templates
                </button>
                <button id="open-icon-modal" class="bg-white border border-gray-300 text-gray-700 font-semibold px-4 py-2 rounded-lg hover:bg-gray-100 transition-colors flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>
                    Ícone
                </button>
                 <button id="save-button" class="bg-pink-500 text-white font-semibold px-4 py-2 rounded-lg hover:bg-pink-600 transition-colors flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6h5a2 2 0 012 2v7a2 2 0 01-2 2H4a2 2 0 01-2-2V8a2 2 0 012-2h5v5.586l-1.293-1.293zM9 4a1 1 0 012 0v2H9V4z" /></svg>
                    Salvar Alterações
                </button>
            </div>
        </header>

        <main class="p-4 sm:p-6 md:p-8 bg-gray-200">
            <div id="event-page-preview" class="max-w-4xl mx-auto bg-white shadow-lg rounded-lg overflow-hidden">
                
                <section id="header-section" class="editable-section relative text-center bg-gray-700">
                    <button class="edit-btn" data-modal="header-modal" title="Editar Cabeçalho"><svg class="w-5 h-5 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" /></svg></button>
                    <div id="header-content-wrapper" class="relative w-full h-[60vh]">
                        <img id="header-image-preview" src="https://placehold.co/1200x600/F8F7F5/C7B2A4?text=Sua+Foto+Aqui" class="w-full h-full object-cover">
                        <div id="header-text-overlay" class="absolute inset-0">
                            <h1 id="couple-names-preview" class="draggable-text text-white text-6xl" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">Nomes Aqui</h1>
                            <p id="event-date-preview" class="draggable-text text-white text-lg" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">Data do Evento</p>
                        </div>
                    </div>
                </section>

                <section id="story-section" class="editable-section p-8 md:p-16 text-center bg-primary-light"></section>
                <section id="details-section" class="editable-section p-8 md:p-16"></section>
                <section id="gallery-section" class="editable-section p-8 md:p-16 bg-primary-light"></section>
                <section id="rsvp-section" class="editable-section p-8 md:p-16 text-center"></section>
            </div>
        </main>
    </div>
    
    <!-- Editor de Texto Flutuante (NOVO) -->
    <div id="text-editor-toolbar" class="flex items-center">
        <select id="font-family-select">
            <option value="'Playfair Display', serif">Playfair Display</option>
            <option value="'Dancing Script', cursive">Dancing Script</option>
            <option value="'Cormorant Garamond', serif">Cormorant Garamond</option>
            <option value="'Montserrat', sans-serif">Montserrat</option>
            <option value="'Roboto', sans-serif">Roboto</option>
        </select>
        <input type="number" id="font-size-input" min="10" max="150" step="1" title="Tamanho da Fonte (px)">
        <input type="color" id="font-color-input" title="Cor da Fonte">
    </div>

    <div id="toast-notification" class="hidden fixed top-5 right-5 text-white px-6 py-3 rounded-lg shadow-lg z-50 transform translate-x-full">
        <p id="toast-message"></p>
    </div>

    <div id="modal-container">
        <!-- Modais existentes (sem alterações) -->
    </div>

    <script type="module">
        import { auth, onAuthStateChanged, db, storage, ref, uploadBytes, getDownloadURL } from './auth.js';
        import { doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { iconLibrary } from './icon-library.js?v=2';

        // --- ELEMENTOS GLOBAIS ---
        const pageContent = document.getElementById('page-content');
        const loadingState = document.getElementById('loading-state');
        const saveButton = document.getElementById('save-button');
        const headerContentWrapper = document.getElementById('header-content-wrapper');

        let currentUser;
        let pageData = {};

        // --- DADOS PADRÃO (COM NOVOS CAMPOS DE ESTILO) ---
        const defaultData = {
            template: 'elegancia',
            icon: iconLibrary.find(i => i.id === 'flower-2').svg,
            header: { 
                coupleNames: ["Noiva & Noivo"], 
                eventDate: "Data do Evento", 
                imageUrl: "https://placehold.co/1200x600/F8F7F5/C7B2A4?text=Sua+Foto+Aqui",
                // Novos campos para estilo e posição do texto
                titleStyle: {
                    fontFamily: "'Playfair Display', serif",
                    fontSize: "60px",
                    color: "#FFFFFF",
                    top: "50%",
                    left: "50%",
                    transform: "translate(-50%, -50%)"
                },
                dateStyle: {
                    fontFamily: "'Inter', sans-serif",
                    fontSize: "20px",
                    color: "#FFFFFF",
                    top: "65%",
                    left: "50%",
                    transform: "translate(-50%, -50%)"
                }
            },
            story: { title: "Nossa História", text: "Clique no botão de edição para contar a sua história de amor..." },
            gallery: { photos: [{ url: "https://placehold.co/400x400/FCE7F3/DB2777?text=Foto+1" }] },
            details: { ceremony: {}, reception: {} },
            rsvp: { title: "Confirme sua Presença", text: "Sua presença é o nosso maior presente!", buttonText: "Confirmar Presença", buttonLink: "#" }
        };

        // --- LÓGICA DE INICIALIZAÇÃO E CARREGAMENTO DE DADOS ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await loadPageData();
                initializePage();
            } else {
                window.location.href = '/login.html';
            }
        });

        async function loadPageData() {
            const pageDataRef = doc(db, 'users', currentUser.uid, 'eventPage', 'details');
            const docSnap = await getDoc(pageDataRef);
            if (docSnap.exists()) {
                const loadedData = docSnap.data();
                // Merge profundo para garantir que os novos campos de estilo existam
                pageData = {
                    ...JSON.parse(JSON.stringify(defaultData)),
                    ...loadedData,
                    header: {
                        ...defaultData.header,
                        ...(loadedData.header || {}),
                        titleStyle: { ...defaultData.header.titleStyle, ...(loadedData.header?.titleStyle || {}) },
                        dateStyle: { ...defaultData.header.dateStyle, ...(loadedData.header?.dateStyle || {}) }
                    }
                };
            } else {
                pageData = JSON.parse(JSON.stringify(defaultData));
                await setDoc(pageDataRef, pageData);
            }
        }

        function initializePage() {
            loadingState.classList.add('hidden');
            pageContent.classList.remove('hidden');
            renderAllPreviews();
            setupEventListeners();
            setupDraggableText(); // Nova função para inicializar o texto arrastável
        }
        
        // --- LÓGICA DO EDITOR DE TEXTO FLUTUANTE ---
        const toolbar = document.getElementById('text-editor-toolbar');
        const fontFamilySelect = document.getElementById('font-family-select');
        const fontSizeInput = document.getElementById('font-size-input');
        const fontColorInput = document.getElementById('font-color-input');
        let selectedTextElement = null;

        function showToolbarFor(element) {
            if (selectedTextElement) {
                selectedTextElement.classList.remove('selected');
            }
            selectedTextElement = element;
            selectedTextElement.classList.add('selected');

            const rect = element.getBoundingClientRect();
            const containerRect = headerContentWrapper.getBoundingClientRect();
            
            toolbar.style.display = 'flex';
            toolbar.style.top = `${rect.top - containerRect.top - toolbar.offsetHeight - 10}px`;
            toolbar.style.left = `${rect.left - containerRect.left + (rect.width / 2) - (toolbar.offsetWidth / 2)}px`;

            // Preencher a toolbar com os estilos atuais do elemento
            fontFamilySelect.value = element.style.fontFamily;
            fontSizeInput.value = parseInt(element.style.fontSize, 10);
            fontColorInput.value = rgbToHex(element.style.color);
        }

        function hideToolbar() {
            toolbar.style.display = 'none';
            if (selectedTextElement) {
                selectedTextElement.classList.remove('selected');
                selectedTextElement = null;
            }
        }
        
        function updateSelectedTextStyle() {
            if (!selectedTextElement) return;
            selectedTextElement.style.fontFamily = fontFamilySelect.value;
            selectedTextElement.style.fontSize = `${fontSizeInput.value}px`;
            selectedTextElement.style.color = fontColorInput.value;
            
            // Salvar a alteração no objeto pageData
            const styleKey = selectedTextElement.id === 'couple-names-preview' ? 'titleStyle' : 'dateStyle';
            pageData.header[styleKey].fontFamily = selectedTextElement.style.fontFamily;
            pageData.header[styleKey].fontSize = selectedTextElement.style.fontSize;
            pageData.header[styleKey].color = selectedTextElement.style.color;
        }

        // --- LÓGICA DE ARRASTAR TEXTO ---
        function setupDraggableText() {
            const draggables = document.querySelectorAll('.draggable-text');
            draggables.forEach(el => {
                let isDragging = false;
                let offsetX, offsetY;

                el.addEventListener('mousedown', (e) => {
                    isDragging = true;
                    offsetX = e.clientX - el.offsetLeft;
                    offsetY = e.clientY - el.offsetTop;
                    showToolbarFor(el);
                    e.stopPropagation(); // Impede que o clique se propague para outros elementos
                });

                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;
                    const containerRect = headerContentWrapper.getBoundingClientRect();
                    let newLeft = e.clientX - offsetX;
                    let newTop = e.clientY - offsetY;

                    // Manter dentro dos limites do container
                    newLeft = Math.max(0, Math.min(newLeft, containerRect.width - el.offsetWidth));
                    newTop = Math.max(0, Math.min(newTop, containerRect.height - el.offsetHeight));

                    el.style.left = `${newLeft}px`;
                    el.style.top = `${newTop}px`;
                    el.style.transform = 'none'; // Remove o transform para usar top/left
                });

                document.addEventListener('mouseup', () => {
                    if (!isDragging) return;
                    isDragging = false;
                    
                    // Salvar a nova posição no objeto pageData
                    const styleKey = el.id === 'couple-names-preview' ? 'titleStyle' : 'dateStyle';
                    pageData.header[styleKey].left = `${(el.offsetLeft / headerContentWrapper.offsetWidth) * 100}%`;
                    pageData.header[styleKey].top = `${(el.offsetTop / headerContentWrapper.offsetHeight) * 100}%`;
                    pageData.header[styleKey].transform = 'none'; // Importante para o novo posicionamento
                });
            });
            
            // Esconder a toolbar se clicar fora
            document.addEventListener('click', (e) => {
                if (!toolbar.contains(e.target) && !e.target.classList.contains('draggable-text')) {
                    hideToolbar();
                }
            });
        }

        // --- RENDERIZAÇÃO ---
        function renderAllPreviews() {
            const { header } = pageData;
            const titleEl = document.getElementById('couple-names-preview');
            const dateEl = document.getElementById('event-date-preview');

            // Aplicar textos
            titleEl.textContent = Array.isArray(header.coupleNames) ? header.coupleNames.join(' & ') : '';
            dateEl.textContent = header.eventDate;
            document.getElementById('header-image-preview').src = header.imageUrl;

            // Aplicar estilos e posições salvas
            Object.assign(titleEl.style, header.titleStyle);
            Object.assign(dateEl.style, header.dateStyle);
        }

        // --- EVENT LISTENERS GERAIS ---
        function setupEventListeners() {
            saveButton.addEventListener('click', handleFullSave);
            
            // Listeners da toolbar
            fontFamilySelect.addEventListener('change', updateSelectedTextStyle);
            fontSizeInput.addEventListener('input', updateSelectedTextStyle);
            fontColorInput.addEventListener('input', updateSelectedTextStyle);
            
            // Outros event listeners (modais, etc.)
        }

        async function handleFullSave() {
            saveButton.disabled = true;
            saveButton.innerHTML = 'A salvar...';
            try {
                await setDoc(doc(db, 'users', currentUser.uid, 'eventPage', 'details'), pageData);
                showToast('Alterações salvas com sucesso!', false);
            } catch (error) {
                console.error("Erro ao salvar dados da página: ", error);
                showToast(`Erro ao salvar: ${error.message}`);
            } finally {
                saveButton.disabled = false;
                saveButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6h5a2 2 0 012 2v7a2 2 0 01-2 2H4a2 2 0 01-2-2V8a2 2 0 012-2h5v5.586l-1.293-1.293zM9 4a1 1 0 012 0v2H9V4z" /></svg> Salvar Alterações`;
            }
        }
        
        // --- FUNÇÕES UTILITÁRIAS ---
        function rgbToHex(rgb) {
            if (!rgb || !rgb.startsWith('rgb')) return '#000000';
            let [r, g, b] = rgb.match(/\d+/g).map(Number);
            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase();
        }
        
        function showToast(message, isError = true) {
            const toast = document.getElementById('toast-notification');
            const toastMessage = document.getElementById('toast-message');
            toastMessage.textContent = message;
            toast.className = `fixed top-5 right-5 text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-transform transform-gpu`;
            toast.classList.add(isError ? 'bg-red-500' : 'bg-green-500');
            toast.classList.remove('hidden', 'translate-x-full');
            toast.classList.add('translate-x-0');

            setTimeout(() => {
                toast.classList.remove('translate-x-0');
                toast.classList.add('translate-x-full');
            }, 4000);
        }

    </script>
</body>
</html>
