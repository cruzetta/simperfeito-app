<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor da Página do Evento - Sim, Perfeito</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Cormorant+Garamond:wght@400;600;700&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F3F4F6; } /* gray-100 */

        /* --- Estilos Base dos Templates --- */
        #event-page-preview {
            --font-display: 'Playfair Display', serif;
            --font-body: 'Cormorant Garamond', serif;
            --font-special: 'Dancing Script', cursive;
            --color-primary: #DB2777; /* pink-600 */
            --color-secondary: #F472B6; /* pink-400 */
            --color-background: #FDF2F8; /* pink-50 */
            --color-text-main: #1F2937; /* gray-800 */
            --color-text-light: #4B5563; /* gray-600 */
            transition: all 0.5s ease;
        }
        #event-page-preview .font-display { font-family: var(--font-display); }
        #event-page-preview .font-body { font-family: var(--font-body); }
        #event-page-preview .font-special { font-family: var(--font-special); }
        #event-page-preview .text-primary { color: var(--color-primary); }
        #event-page-preview .bg-primary-light { background-color: var(--color-background); }
        #event-page-preview .border-primary { border-color: var(--color-primary); }
        #event-page-preview .section-graphic { display: none; }

        /* Template: Elegância (e outros) */
        #event-page-preview.template-elegancia .section-graphic,
        #event-page-preview.template-classic .section-graphic,
        #event-page-preview.template-romantic .section-graphic { 
            display: block; 
            margin: 0 auto 1rem; 
            color: var(--color-primary); 
        }
        #event-page-preview.template-modern .section-graphic {
             display: none; /* Ícone não combina com o template moderno */
        }
        #event-page-preview.template-elegancia #couple-names-preview { font-family: var(--font-display); }
        #event-page-preview.template-elegancia .section-title { font-family: var(--font-body); font-weight: 600; }
        
        /* Outros estilos de templates... */
        #event-page-preview.template-classic { --font-display: 'Playfair Display', serif; --font-body: 'Cormorant Garamond', serif; --color-primary: #831843; --color-background: #F8F7F5; --color-text-main: #37322F; }
        #event-page-preview.template-modern { --font-display: 'Inter', sans-serif; --font-body: 'Inter', sans-serif; --color-primary: #111827; --color-background: #F9FAFB; --color-text-main: #1F2937; }
        #event-page-preview.template-modern #header-section h1 { font-weight: 700; }
        #event-page-preview.template-modern #story-section, #event-page-preview.template-modern #details-section { text-align: left; }
        #event-page-preview.template-modern .section-title { text-align: left; }
        #event-page-preview.template-romantic { --font-display: 'Dancing Script', cursive; --font-body: 'Cormorant Garamond', serif; --color-primary: #DB2777; --color-background: #FFF1F2; --color-text-main: #881337; }
        #event-page-preview.template-romantic #header-section { border-bottom: 4px solid var(--color-primary); }

        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .editable-section { position: relative; border: 2px dashed transparent; transition: border-color 0.3s; }
        .editable-section:hover { border-color: #F472B6; } /* pink-400 */
        .edit-btn { position: absolute; top: 1rem; right: 1rem; background-color: white; color: #4B5563; border-radius: 9999px; padding: 0.5rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; transition: all 0.2s; z-index: 10; }
        .edit-btn:hover { background-color: #EC4899; color: white; transform: scale(1.1); }
        
        .modal { position: fixed; inset: 0; background-color: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 50; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .modal.is-open { opacity: 1; visibility: visible; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 0.75rem; width: 90%; max-width: 50rem; max-height: 90vh; overflow-y: auto; transform: scale(0.95); transition: transform 0.3s; }
        .modal.is-open .modal-content { transform: scale(1); }

        .template-card, .icon-card { cursor: pointer; border: 2px solid #E5E7EB; border-radius: 0.5rem; overflow: hidden; transition: all 0.2s ease-in-out; }
        .template-card:hover, .icon-card:hover { border-color: var(--color-primary); transform: translateY(-5px); box-shadow: 0 4px 10px rgba(0,0,0,0.08); }
        .template-card.active, .icon-card.active { border-color: var(--color-primary); border-width: 3px; background-color: #FDF2F8; }
        .icon-card svg { width: 2.5rem; height: 2.5rem; margin: auto; color: #4B5563; }
        .icon-card.active svg { color: var(--color-primary); }

        .drop-zone { transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out; }
        .drop-zone.drag-over { background-color: #FCE7F3; border-color: #F472B6; }
    </style>
</head>
<body>

    <!-- Tela de Carregamento -->
    <div id="loading-state" class="min-h-screen flex items-center justify-center">
        <p class="text-lg text-gray-500">A carregar o editor da sua página...</p>
    </div>

    <!-- Conteúdo da Página -->
    <div id="page-content" class="hidden">
        <header class="flex items-center justify-between h-16 px-6 bg-white border-b sticky top-0 z-40">
            <span id="header-title" class="text-xl font-bold text-gray-800 font-display">Editor da Página</span>
            <div class="flex items-center gap-4">
                 <a id="view-public-page" href="#" target="_blank" class="text-sm text-pink-600 hover:underline font-semibold">Ver Página Pública</a>
                 <button id="open-template-modal" class="bg-white border border-gray-300 text-gray-700 font-semibold px-4 py-2 rounded-lg hover:bg-gray-100 transition-colors flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z" /></svg>
                    Templates
                </button>
                <!-- BOTÃO DE ÍCONE -->
                <button id="open-icon-modal" class="bg-white border border-gray-300 text-gray-700 font-semibold px-4 py-2 rounded-lg hover:bg-gray-100 transition-colors flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>
                    Ícone
                </button>
                 <button id="save-button" class="bg-pink-500 text-white font-semibold px-4 py-2 rounded-lg hover:bg-pink-600 transition-colors flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6h5a2 2 0 012 2v7a2 2 0 01-2 2H4a2 2 0 01-2-2V8a2 2 0 012-2h5v5.586l-1.293-1.293zM9 4a1 1 0 012 0v2H9V4z" /></svg>
                    Salvar Alterações
                </button>
            </div>
        </header>

        <main class="p-4 sm:p-6 md:p-8 bg-gray-200">
            <div id="success-message" class="hidden bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded-md mb-6" role="alert">
                <p class="font-bold">Sucesso!</p>
                <p>As suas alterações foram salvas.</p>
            </div>
            
            <div id="event-page-preview" class="max-w-4xl mx-auto bg-white shadow-lg rounded-lg overflow-hidden">
                
                <section id="header-section" class="editable-section relative text-center bg-gray-300">
                    <button class="edit-btn" data-modal="header-modal" title="Editar Cabeçalho"><svg class="w-5 h-5 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" /></svg></button>
                    <img id="header-image-preview" src="https://placehold.co/1200x600/F8F7F5/C7B2A4?text=Sua+Foto+Aqui" class="w-full h-96 object-cover">
                    <div class="absolute inset-0 bg-black/30 flex flex-col items-center justify-center p-4">
                        <h1 id="couple-names-preview" class="font-display text-white text-4xl md:text-6xl" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">Nomes Aqui</h1>
                        <p id="event-date-preview" class="text-white text-lg mt-2" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">Data do Evento</p>
                    </div>
                </section>

                <section id="story-section" class="editable-section p-8 md:p-16 text-center bg-primary-light">
                     <button class="edit-btn" data-modal="story-modal" title="Editar Título e História"><svg class="w-5 h-5 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" /></svg></button>
                    <div class="section-graphic w-16 h-10"></div>
                    <h2 id="story-title-preview" class="section-title font-display text-3xl md:text-4xl text-primary">Nossa História</h2>
                    <p id="story-text-preview" class="font-body text-lg md:text-xl mt-6 max-w-2xl mx-auto leading-relaxed" style="color: var(--color-text-light);">Clique no botão de edição para contar a sua história de amor, a jornada até a formatura ou as boas-vindas para a sua festa de aniversário. Este espaço é seu!</p>
                </section>

                <section id="details-section" class="editable-section p-8 md:p-16">
                     <button class="edit-btn" data-modal="details-modal" title="Editar Detalhes do Evento"><svg class="w-5 h-5 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" /></svg></button>
                    <div class="section-graphic w-16 h-10"></div>
                    <h2 class="section-title font-display text-3xl md:text-4xl text-primary text-center mb-12">Detalhes do Evento</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-12 max-w-4xl mx-auto">
                        <div id="ceremony-details-preview" class="text-center"></div>
                        <div id="reception-details-preview" class="text-center"></div>
                    </div>
                </section>

                <section id="gallery-section" class="editable-section p-8 md:p-16 bg-primary-light">
                     <button class="edit-btn" data-modal="gallery-modal" title="Editar Galeria de Fotos"><svg class="w-5 h-5 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" /></svg></button>
                     <div class="section-graphic w-16 h-10"></div>
                    <h2 class="section-title font-display text-3xl md:text-4xl text-primary text-center mb-8">Nossos Momentos</h2>
                    <div id="gallery-preview-container" class="grid grid-cols-2 md:grid-cols-3 gap-4"></div>
                </section>

                <section id="rsvp-section" class="editable-section p-8 md:p-16 text-center">
                    <button class="edit-btn" data-modal="rsvp-modal" title="Editar Confirmação de Presença"><svg class="w-5 h-5 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" /></svg></button>
                    <div class="section-graphic w-16 h-10"></div>
                    <h2 id="rsvp-title-preview" class="section-title font-display text-3xl md:text-4xl text-primary">Confirme sua Presença</h2>
                    <p id="rsvp-text-preview" class="font-body text-lg md:text-xl mt-6 max-w-2xl mx-auto leading-relaxed" style="color: var(--color-text-light);"></p>
                    <a id="rsvp-button-preview" href="#" target="_blank" class="inline-block mt-8 px-8 py-3 bg-primary text-white font-bold rounded-lg shadow-md hover:opacity-90 transition-opacity" style="background-color: var(--color-primary);"></a>
                </section>

            </div>
        </main>
    </div>

    <!-- Modais de Edição -->
    <div id="modal-container">
        <!-- Modal de Ícones -->
        <div id="icon-modal" class="modal">
            <div class="modal-content">
                <h3 class="text-xl font-bold mb-4">Escolha um Ícone para o seu Evento</h3>
                <p class="text-gray-600 mb-6">Este ícone aparecerá como um detalhe gráfico nas seções da sua página.</p>
                <div id="icon-selection-container" class="grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 lg:grid-cols-10 gap-4">
                    <!-- Ícones serão inseridos aqui pelo JavaScript -->
                </div>
                 <div class="flex justify-end gap-2 mt-8">
                    <button type="button" class="modal-close-btn px-6 py-2 bg-pink-500 text-white rounded-md">Confirmar</button>
                </div>
            </div>
        </div>
        
        <!-- Outros Modais (Templates, Header, etc.) -->
        <div id="template-modal" class="modal"><div class="modal-content"><h3 class="text-xl font-bold mb-4">Escolha um Template</h3><p class="text-gray-600 mb-6">Selecione um estilo visual para sua página. Todas as suas informações serão mantidas.</p><div id="template-selection-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6"><div class="template-card" data-template="classic"><div class="p-4 border-b text-center" style="background-color: #F8F7F5;"><h4 style="font-family: 'Playfair Display', serif; color: #831843; font-size: 1.5rem;">Clássico</h4></div><div class="p-4"><p class="text-sm text-gray-500">Elegante e atemporal.</p></div></div><div class="template-card" data-template="modern"><div class="p-4 border-b text-center" style="background-color: #F9FAFB;"><h4 style="font-family: 'Inter', sans-serif; color: #111827; font-size: 1.5rem; font-weight: 700;">Moderno</h4></div><div class="p-4"><p class="text-sm text-gray-500">Minimalista e limpo.</p></div></div><div class="template-card" data-template="romantic"><div class="p-4 border-b text-center" style="background-color: #FFF1F2;"><h4 style="font-family: 'Dancing Script', cursive; color: #DB2777; font-size: 1.5rem;">Romântico</h4></div><div class="p-4"><p class="text-sm text-gray-500">Delicado e sonhador.</p></div></div><div class="template-card" data-template="elegancia"><div class="p-4 border-b text-center" style="background-color: #F9FAFB;"><h4 style="font-family: 'Dancing Script', cursive; color: #374151; font-size: 1.5rem;">Elegância</h4></div><div class="p-4"><p class="text-sm text-gray-500">Sofisticado e refinado.</p></div></div></div><div class="flex justify-end gap-2 mt-8"><button type="button" class="modal-close-btn px-6 py-2 bg-gray-200 rounded-md">Fechar</button></div></div></div>
        <div id="header-modal" class="modal"><div class="modal-content"><h3 class="text-xl font-bold mb-4">Editar Cabeçalho</h3><form id="header-form" class="space-y-4"><div><label for="couple-names-input" class="block text-sm font-medium text-gray-700 mb-1">Nomes (separados por vírgula)</label><input type="text" id="couple-names-input" class="w-full p-2 border border-gray-300 rounded-md"></div><div><label for="event-date-input" class="block text-sm font-medium text-gray-700 mb-1">Texto da Data</label><input type="text" id="event-date-input" class="w-full p-2 border border-gray-300 rounded-md"></div><div><label class="block text-sm font-medium text-gray-700 mb-1">Foto Principal</label><div id="header-image-uploader" class="image-uploader"></div></div><div class="flex justify-end gap-2 mt-6"><button type="button" class="modal-close-btn px-4 py-2 bg-gray-200 rounded-md">Cancelar</button><button type="submit" class="modal-save-btn px-4 py-2 bg-pink-500 text-white rounded-md">Salvar</button></div></form></div></div>
        <div id="gallery-modal" class="modal"><div class="modal-content"><h3 class="text-xl font-bold mb-4">Editar Galeria de Fotos</h3><form id="gallery-form"><div id="gallery-inputs-container" class="space-y-6 mb-4"></div><button type="button" id="add-photo-btn" class="text-sm text-pink-600 font-semibold hover:text-pink-800 mb-4">+ Adicionar outra foto</button><div class="flex justify-end gap-2 mt-6"><button type="button" class="modal-close-btn px-4 py-2 bg-gray-200 rounded-md">Cancelar</button><button type="submit" class="modal-save-btn px-4 py-2 bg-pink-500 text-white rounded-md">Salvar</button></div></form></div></div>
        <div id="story-modal" class="modal"><div class="modal-content"><h3 class="text-xl font-bold mb-4">Editar História</h3><form id="story-form" class="space-y-4"><div><label for="story-title-input" class="block text-sm font-medium text-gray-700 mb-1">Título da Seção</label><input type="text" id="story-title-input" class="w-full p-2 border border-gray-300 rounded-md"></div><div><label for="story-text-input" class="block text-sm font-medium text-gray-700 mb-1">Texto da História</label><textarea id="story-text-input" rows="8" class="w-full p-2 border border-gray-300 rounded-md"></textarea></div><div class="flex justify-end gap-2 mt-6"><button type="button" class="modal-close-btn px-4 py-2 bg-gray-200 rounded-md">Cancelar</button><button type="submit" class="modal-save-btn px-4 py-2 bg-pink-500 text-white rounded-md">Salvar</button></div></form></div></div>
        <div id="details-modal" class="modal"><div class="modal-content"><h3 class="text-xl font-bold mb-4">Editar Detalhes do Evento</h3><form id="details-form" class="space-y-6"><fieldset class="border p-4 rounded-md"><legend class="text-lg font-semibold px-2">Cerimónia</legend><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="ceremony-name" class="block text-sm font-medium text-gray-700 mb-1">Nome do Local</label><input type="text" id="ceremony-name" class="w-full p-2 border border-gray-300 rounded-md"></div><div><label for="ceremony-time" class="block text-sm font-medium text-gray-700 mb-1">Data e Hora</label><input type="text" id="ceremony-time" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Ex: Sábado, 25 de Outubro de 2025, às 16:00"></div></div><div class="mt-4"><label for="ceremony-address" class="block text-sm font-medium text-gray-700 mb-1">Endereço</label><input type="text" id="ceremony-address" class="w-full p-2 border border-gray-300 rounded-md"></div><div class="mt-4"><label for="ceremony-map" class="block text-sm font-medium text-gray-700 mb-1">URL do Google Maps</label><input type="url" id="ceremony-map" class="w-full p-2 border border-gray-300 rounded-md"></div></fieldset><fieldset class="border p-4 rounded-md"><legend class="text-lg font-semibold px-2">Recepção</legend><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="reception-name" class="block text-sm font-medium text-gray-700 mb-1">Nome do Local</label><input type="text" id="reception-name" class="w-full p-2 border border-gray-300 rounded-md"></div><div><label for="reception-time" class="block text-sm font-medium text-gray-700 mb-1">Hora</label><input type="text" id="reception-time" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Ex: Logo após a cerimónia"></div></div><div class="mt-4"><label for="reception-address" class="block text-sm font-medium text-gray-700 mb-1">Endereço</label><input type="text" id="reception-address" class="w-full p-2 border border-gray-300 rounded-md"></div><div class="mt-4"><label for="reception-map" class="block text-sm font-medium text-gray-700 mb-1">URL do Google Maps</label><input type="url" id="reception-map" class="w-full p-2 border border-gray-300 rounded-md"></div></fieldset><div class="flex justify-end gap-2 mt-6"><button type="button" class="modal-close-btn px-4 py-2 bg-gray-200 rounded-md">Cancelar</button><button type="submit" class="modal-save-btn px-4 py-2 bg-pink-500 text-white rounded-md">Salvar</button></div></form></div></div>
        <div id="rsvp-modal" class="modal"><div class="modal-content"><h3 class="text-xl font-bold mb-4">Editar Confirmação de Presença</h3><form id="rsvp-form" class="space-y-4"><div><label for="rsvp-title-input" class="block text-sm font-medium text-gray-700 mb-1">Título da Seção</label><input type="text" id="rsvp-title-input" class="w-full p-2 border border-gray-300 rounded-md"></div><div><label for="rsvp-text-input" class="block text-sm font-medium text-gray-700 mb-1">Texto de Apoio</label><textarea id="rsvp-text-input" rows="4" class="w-full p-2 border border-gray-300 rounded-md"></textarea></div><div><label for="rsvp-button-text-input" class="block text-sm font-medium text-gray-700 mb-1">Texto do Botão</label><input type="text" id="rsvp-button-text-input" class="w-full p-2 border border-gray-300 rounded-md"></div><div><label for="rsvp-button-link-input" class="block text-sm font-medium text-gray-700 mb-1">Link do Botão (para seu formulário de RSVP)</label><input type="url" id="rsvp-button-link-input" class="w-full p-2 border border-gray-300 rounded-md" placeholder="https://seu-link-de-rsvp.com"></div><div class="flex justify-end gap-2 mt-6"><button type="button" class="modal-close-btn px-4 py-2 bg-gray-200 rounded-md">Cancelar</button><button type="submit" class="modal-save-btn px-4 py-2 bg-pink-500 text-white rounded-md">Salvar</button></div></form></div></div>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { auth, onAuthStateChanged, db, storage, ref, uploadBytes, getDownloadURL } from './auth.js';
        import { doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        // Importa a biblioteca de ícones
        import { iconLibrary } from './icon-library.js?v=2'; // <-- CORREÇÃO AQUI

        // --- ELEMENTOS GLOBAIS ---
        const loadingState = document.getElementById('loading-state');
        const pageContent = document.getElementById('page-content');
        const saveButton = document.getElementById('save-button');
        const successMessage = document.getElementById('success-message');
        const viewPublicPageLink = document.getElementById('view-public-page');
        const eventPagePreview = document.getElementById('event-page-preview');

        let currentUser;
        let eventConfig;
        let pageData = {};

        const defaultData = {
            template: 'elegancia',
            icon: iconLibrary.find(i => i.id === 'flower-2').svg, // Ícone padrão
            header: { coupleNames: ["Noiva & Noivo"], eventDate: "Data do Evento", imageUrl: "https://placehold.co/1200x600/F8F7F5/C7B2A4?text=Sua+Foto+Aqui" },
            story: { title: "Nossa História", text: "Clique no botão de edição para contar a sua história de amor..." },
            gallery: { photos: [{ url: "https://placehold.co/400x400/FCE7F3/DB2777?text=Foto+1" }, { url: "https://placehold.co/400x400/FCE7F3/DB2777?text=Foto+2" }, { url: "https://placehold.co/400x400/FCE7F3/DB2777?text=Foto+3" }] },
            details: { ceremony: { name: "Local da Cerimônia", address: "Endereço, 123", time: "Sábado, 25 de Outubro de 2025, às 16:00", mapUrl: "#" }, reception: { name: "Local da Recepção", address: "Endereço, 456", time: "Logo após a cerimónia", mapUrl: "#" } },
            rsvp: { title: "Confirme sua Presença", text: "Sua presença é o nosso maior presente! Por favor, confirme até o dia DD/MM/AAAA.", buttonText: "Confirmar Presença", buttonLink: "#" }
        };

        // --- INICIALIZAÇÃO ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                viewPublicPageLink.href = `/convite.html?user=${user.uid}`; // Corrigido para apontar para o convite
                try {
                    await loadEventConfig();
                    await loadPageData();
                    initializePage();
                } catch (error) {
                    console.error("Erro fatal na inicialização da página:", error);
                    loadingState.innerHTML = `<p class="text-lg text-red-500">Ocorreu um erro ao carregar os dados. Tente recarregar a página.</p>`;
                }
            } else {
                window.location.href = '/login.html';
            }
        });

        function initializePage() {
            loadingState.classList.add('hidden');
            pageContent.classList.remove('hidden');
            applyTemplate(pageData.template || 'elegancia');
            renderAllPreviews();
            setupEventListeners();
            populateIconModal();
            createImageUploader(document.getElementById('header-image-uploader'), pageData.header.imageUrl);
        }

        async function loadEventConfig() {
            const configRef = doc(db, 'users', currentUser.uid, 'config', 'event');
            const configSnap = await getDoc(configRef);
            eventConfig = configSnap.exists() ? configSnap.data() : { type: 'outro' };
        }
        
        async function loadPageData() {
            const pageDataRef = doc(db, 'users', currentUser.uid, 'eventPage', 'details');
            const docSnap = await getDoc(pageDataRef);

            if (!docSnap.exists()) {
                pageData = JSON.parse(JSON.stringify(defaultData));
                await setDoc(pageDataRef, pageData);
            } else {
                const loadedData = docSnap.data();
                // Merge profundo para garantir que todos os campos padrão existam
                pageData = {
                    ...JSON.parse(JSON.stringify(defaultData)),
                    ...loadedData,
                    header: { ...defaultData.header, ...(loadedData.header || {}) },
                    story: { ...defaultData.story, ...(loadedData.story || {}) },
                    gallery: { ...defaultData.gallery, ...(loadedData.gallery || {}) },
                    details: { ...defaultData.details, ...(loadedData.details || {}) },
                    rsvp: { ...defaultData.rsvp, ...(loadedData.rsvp || {}) }
                };
                 if (!Array.isArray(pageData.gallery.photos) || pageData.gallery.photos.length === 0) {
                    pageData.gallery.photos = defaultData.gallery.photos;
                }
            }
        }
        
        // --- LÓGICA DE ÍCONES ---
        function populateIconModal() {
            const container = document.getElementById('icon-selection-container');
            container.innerHTML = '';
            iconLibrary.forEach(icon => {
                const card = document.createElement('div');
                card.className = 'icon-card p-4 flex items-center justify-center';
                card.dataset.iconId = icon.id;
                card.innerHTML = icon.svg;
                if (pageData.icon === icon.svg) {
                    card.classList.add('active');
                }
                card.addEventListener('click', () => {
                    pageData.icon = icon.svg;
                    document.querySelectorAll('#icon-selection-container .icon-card').forEach(c => c.classList.remove('active'));
                    card.classList.add('active');
                    renderAllPreviews();
                });
                container.appendChild(card);
            });
        }

        // --- LÓGICA DE UPLOAD DE IMAGEM ---
        function createImageUploader(container, existingUrl = '') {
            container.innerHTML = `<div class="bg-gray-50 p-4 rounded-lg border"><label class="drop-zone border-2 border-dashed rounded-lg p-6 text-center cursor-pointer hover:border-pink-400 bg-white"><div class="uploader-prompt"><svg class="mx-auto h-10 w-10 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" /></svg><p class="mt-2 text-sm text-gray-600">Arraste uma foto aqui ou <span class="font-semibold text-pink-600">clique para selecionar</span></p></div><input type="file" class="hidden" accept="image/*"></label><div class="preview-container mt-4 text-center" style="display: none;"><img class="preview-image max-h-40 rounded-lg inline-block"><p class="loading-text text-sm text-gray-500 mt-2" style="display: none;">A enviar...</p></div><div class="my-3 flex items-center"><div class="flex-grow border-t"></div><span class="flex-shrink mx-4 text-gray-400 text-xs">OU</span><div class="flex-grow border-t"></div></div><div><input type="url" class="url-input w-full p-2 border border-gray-300 rounded-md text-sm" placeholder="Cole a URL da imagem aqui"></div></div>`;
            const fileInput = container.querySelector('input[type="file"]');
            const urlInput = container.querySelector('.url-input');
            const previewImage = container.querySelector('.preview-image');
            container.dataSource = { type: 'url', value: existingUrl };
            const showPreview = (src) => { previewImage.src = src; container.querySelector('.preview-container').style.display = 'block'; };
            if (existingUrl) { showPreview(existingUrl); urlInput.value = existingUrl; }
            container.querySelector('.drop-zone').addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', e => { if (e.target.files.length) { container.dataSource = { type: 'file', value: e.target.files[0] }; const reader = new FileReader(); reader.onload = (ev) => showPreview(ev.target.result); reader.readAsDataURL(e.target.files[0]); } });
            urlInput.addEventListener('input', () => { const url = urlInput.value.trim(); container.dataSource = { type: 'url', value: url }; if(url) showPreview(url); });
        }
        async function uploadImageAndGetURL(file) { if (!file) return null; const storageRef = ref(storage, `users/${currentUser.uid}/eventImages/${Date.now()}-${file.name}`); await uploadBytes(storageRef, file); return await getDownloadURL(storageRef); }

        // --- LÓGICA DE SALVAMENTO ---
        async function handleHeaderSave(e) { e.preventDefault(); const uploader = document.getElementById('header-image-uploader'); const saveBtn = e.target.querySelector('.modal-save-btn'); saveBtn.disabled = true; saveBtn.textContent = 'A salvar...'; const newHeaderData = { coupleNames: document.getElementById('couple-names-input').value.split(',').map(name => name.trim()), eventDate: document.getElementById('event-date-input').value, imageUrl: pageData.header.imageUrl }; const { type, value } = uploader.dataSource; if (type === 'file' && value) { try { newHeaderData.imageUrl = await uploadImageAndGetURL(value); } catch (err) { console.error("Upload failed", err); alert("O envio da imagem falhou."); saveBtn.disabled = false; saveBtn.textContent = 'Salvar'; return; } } else if (type === 'url') { newHeaderData.imageUrl = value; } try { pageData.header = newHeaderData; await updateDoc(doc(db, 'users', currentUser.uid, 'eventPage', 'details'), { header: pageData.header }); renderAllPreviews(); closeModal(e.target.closest('.modal')); } catch (error) { console.error("Erro ao salvar cabeçalho:", error); } finally { saveBtn.disabled = false; saveBtn.textContent = 'Salvar'; } }
        async function handleGallerySave(e) { e.preventDefault(); const saveBtn = e.target.querySelector('.modal-save-btn'); saveBtn.disabled = true; saveBtn.textContent = 'A salvar...'; const uploaderDivs = document.querySelectorAll('#gallery-inputs-container .image-uploader-wrapper'); try { const uploadPromises = Array.from(uploaderDivs).map(async (wrapper) => { const uploader = wrapper.querySelector('.image-uploader'); const { type, value } = uploader.dataSource; if (type === 'file' && value) { return uploadImageAndGetURL(value); } return value; }); const urls = await Promise.all(uploadPromises); pageData.gallery.photos = urls.filter(url => url).map(url => ({ url })); await updateDoc(doc(db, 'users', currentUser.uid, 'eventPage', 'details'), { "gallery.photos": pageData.gallery.photos }); renderAllPreviews(); closeModal(e.target.closest('.modal')); } catch (err) { console.error("Gallery save failed", err); } finally { saveBtn.disabled = false; saveBtn.textContent = 'Salvar'; } }
        function addPhotoField(url = '') { const container = document.getElementById('gallery-inputs-container'); const wrapper = document.createElement('div'); wrapper.className = 'image-uploader-wrapper relative border-t pt-6 mt-6'; const uploaderDiv = document.createElement('div'); uploaderDiv.className = 'image-uploader'; const removeBtn = document.createElement('button'); removeBtn.type = 'button'; removeBtn.className = 'absolute top-0 right-0 text-red-500 hover:text-red-700 p-1 rounded-full'; removeBtn.innerHTML = `<svg class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>`; removeBtn.onclick = () => wrapper.remove(); wrapper.appendChild(uploaderDiv); wrapper.appendChild(removeBtn); container.appendChild(wrapper); createImageUploader(uploaderDiv, url); }
        async function handleFullSave() { saveButton.disabled = true; saveButton.textContent = 'A salvar...'; try { await setDoc(doc(db, 'users', currentUser.uid, 'eventPage', 'details'), { ...pageData, updatedAt: new Date() }); successMessage.classList.remove('hidden'); window.scrollTo(0, 0); setTimeout(() => successMessage.classList.add('hidden'), 3000); } catch (error) { console.error("Erro ao salvar dados da página: ", error); } finally { saveButton.disabled = false; saveButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6h5a2 2 0 012 2v7a2 2 0 01-2 2H4a2 2 0 01-2-2V8a2 2 0 012-2h5v5.586l-1.293-1.293zM9 4a1 1 0 012 0v2H9V4z" /></svg> Salvar Alterações`; } }

        // --- RENDERIZAÇÃO ---
        function applyTemplate(templateId) { eventPagePreview.className = 'max-w-4xl mx-auto bg-white shadow-lg rounded-lg overflow-hidden'; eventPagePreview.classList.add(`template-${templateId}`); pageData.template = templateId; document.querySelectorAll('.template-card').forEach(card => card.classList.toggle('active', card.dataset.template === templateId)); renderAllPreviews(); }
        function renderAllPreviews() {
            const { header, story, details, gallery, rsvp, icon } = pageData;
            document.getElementById('couple-names-preview').textContent = Array.isArray(header.coupleNames) ? header.coupleNames.join(' & ') : '';
            document.getElementById('event-date-preview').textContent = header.eventDate;
            const imgPreview = document.getElementById('header-image-preview'); imgPreview.src = header.imageUrl || defaultData.header.imageUrl; imgPreview.onerror = () => { imgPreview.src = defaultData.header.imageUrl; };
            document.getElementById('story-title-preview').textContent = story.title;
            document.getElementById('story-text-preview').textContent = story.text;
            document.getElementById('ceremony-details-preview').innerHTML = `<h3 class="font-display text-2xl text-primary">Cerimónia</h3><p class="mt-2 font-semibold text-lg" style="color: var(--color-text-main);">${details.ceremony.name || ''}</p><p style="color: var(--color-text-light);">${details.ceremony.address || ''}</p><p class="mt-1" style="color: var(--color-text-light);">${details.ceremony.time || ''}</p><a href="${details.ceremony.mapUrl || '#'}" target="_blank" class="mt-2 inline-block font-semibold text-primary hover:underline">Ver no mapa</a>`;
            document.getElementById('reception-details-preview').innerHTML = `<h3 class="font-display text-2xl text-primary">Recepção</h3><p class="mt-2 font-semibold text-lg" style="color: var(--color-text-main);">${details.reception.name || ''}</p><p style="color: var(--color-text-light);">${details.reception.address || ''}</p><p class="mt-1" style="color: var(--color-text-light);">${details.reception.time || ''}</p><a href="${details.reception.mapUrl || '#'}" target="_blank" class="mt-2 inline-block font-semibold text-primary hover:underline">Ver no mapa</a>`;
            const galleryContainer = document.getElementById('gallery-preview-container'); galleryContainer.innerHTML = ''; (gallery.photos || []).forEach(photo => { const img = document.createElement('img'); img.src = photo.url; img.className = 'rounded-lg shadow-md object-cover w-full h-full aspect-square'; img.onerror = () => { img.src = 'https://placehold.co/400x400/FCE7F3/DB2777?text=Inválida'; }; galleryContainer.appendChild(img); });
            document.getElementById('rsvp-title-preview').textContent = rsvp.title;
            document.getElementById('rsvp-text-preview').textContent = rsvp.text;
            const rsvpButton = document.getElementById('rsvp-button-preview'); rsvpButton.textContent = rsvp.buttonText; rsvpButton.href = rsvp.buttonLink || '#';
            document.querySelectorAll('.section-graphic').forEach(el => el.innerHTML = icon || '');
        }

        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            document.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', () => openModal(btn.dataset.modal)));
            document.getElementById('open-template-modal').addEventListener('click', () => openModal('template-modal'));
            document.getElementById('open-icon-modal').addEventListener('click', () => openModal('icon-modal'));
            document.querySelectorAll('.modal-close-btn').forEach(btn => btn.addEventListener('click', () => closeModal(btn.closest('.modal'))));
            document.querySelectorAll('.template-card').forEach(card => card.addEventListener('click', () => applyTemplate(card.dataset.template)));
            document.getElementById('header-form').addEventListener('submit', handleHeaderSave);
            document.getElementById('story-form').addEventListener('submit', async (e) => { e.preventDefault(); pageData.story.title = document.getElementById('story-title-input').value; pageData.story.text = document.getElementById('story-text-input').value; await updateDoc(doc(db, 'users', currentUser.uid, 'eventPage', 'details'), { story: pageData.story }); renderAllPreviews(); closeModal(e.target.closest('.modal')); });
            document.getElementById('details-form').addEventListener('submit', async (e) => { e.preventDefault(); pageData.details.ceremony = { name: document.getElementById('ceremony-name').value, time: document.getElementById('ceremony-time').value, address: document.getElementById('ceremony-address').value, mapUrl: document.getElementById('ceremony-map').value }; pageData.details.reception = { name: document.getElementById('reception-name').value, time: document.getElementById('reception-time').value, address: document.getElementById('reception-address').value, mapUrl: document.getElementById('reception-map').value }; await updateDoc(doc(db, 'users', currentUser.uid, 'eventPage', 'details'), { details: pageData.details }); renderAllPreviews(); closeModal(e.target.closest('.modal')); });
            document.getElementById('rsvp-form').addEventListener('submit', async (e) => { e.preventDefault(); pageData.rsvp = { title: document.getElementById('rsvp-title-input').value, text: document.getElementById('rsvp-text-input').value, buttonText: document.getElementById('rsvp-button-text-input').value, buttonLink: document.getElementById('rsvp-button-link-input').value }; await updateDoc(doc(db, 'users', currentUser.uid, 'eventPage', 'details'), { rsvp: pageData.rsvp }); renderAllPreviews(); closeModal(e.target.closest('.modal')); });
            document.getElementById('gallery-form').addEventListener('submit', handleGallerySave);
            saveButton.addEventListener('click', handleFullSave);
            document.getElementById('add-photo-btn').addEventListener('click', () => addPhotoField());
        }
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                if (modalId === 'header-modal') { document.getElementById('couple-names-input').value = pageData.header.coupleNames.join(', '); document.getElementById('event-date-input').value = pageData.header.eventDate; }
                else if (modalId === 'story-modal') { document.getElementById('story-title-input').value = pageData.story.title; document.getElementById('story-text-input').value = pageData.story.text; }
                else if (modalId === 'gallery-modal') { populateGalleryForm(); }
                else if (modalId === 'details-modal') { const { ceremony, reception } = pageData.details; document.getElementById('ceremony-name').value = ceremony.name; document.getElementById('ceremony-time').value = ceremony.time; document.getElementById('ceremony-address').value = ceremony.address; document.getElementById('ceremony-map').value = ceremony.mapUrl; document.getElementById('reception-name').value = reception.name; document.getElementById('reception-time').value = reception.time; document.getElementById('reception-address').value = reception.address; document.getElementById('reception-map').value = reception.mapUrl; }
                else if (modalId === 'rsvp-modal') { const { rsvp } = pageData; document.getElementById('rsvp-title-input').value = rsvp.title; document.getElementById('rsvp-text-input').value = rsvp.text; document.getElementById('rsvp-button-text-input').value = rsvp.buttonText; document.getElementById('rsvp-button-link-input').value = rsvp.buttonLink; }
                modal.classList.add('is-open');
            }
        }
        function closeModal(modal) { modal.classList.remove('is-open'); }
        function populateGalleryForm() { const container = document.getElementById('gallery-inputs-container'); container.innerHTML = ''; (pageData.gallery.photos || []).forEach(photo => addPhotoField(photo.url)); }
    </script>
    <!-- CORREÇÃO: Adicionado "?v=2" para forçar o navegador a carregar a nova versão da biblioteca de ícones -->
    <script type="module" src="./icon-library.js?v=2"></script>
</body>
</html>
